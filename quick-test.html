<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Database Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üîç Quick Database Test</h1>
  
  <div class="section">
    <h2>Step 1: Create Test Tutor Account</h2>
    <p>First, we need a tutor account to view the dashboard</p>
    <button onclick="createTutorAccount()">Create Tutor Account</button>
    <div id="tutorResult"></div>
  </div>

  <div class="section">
    <h2>Step 2: Create Test Student & Progress</h2>
    <p>Create a student account and add some test scores</p>
    <button onclick="createStudentAndProgress()">Create Student with Progress</button>
    <div id="studentResult"></div>
  </div>

  <div class="section">
    <h2>Step 3: Login as Tutor</h2>
    <p>Login with the tutor account created above</p>
    <button onclick="loginTutor()">Login as Tutor</button>
    <div id="loginResult"></div>
  </div>

  <div class="section">
    <h2>Step 4: Check Dashboard Data</h2>
    <p>View what the tutor dashboard should show</p>
    <button onclick="checkDashboard()">Check Dashboard Data</button>
    <div id="dashboardResult"></div>
  </div>

  <script>
    const API = 'https://language-tutor-efn5.onrender.com/api';
    let tutorEmail = '';
    let tutorPassword = '';
    let tutorToken = '';

    async function createTutorAccount() {
      const result = document.getElementById('tutorResult');
      result.innerHTML = '<p class="info">Creating tutor account...</p>';
      
      try {
        tutorEmail = `tutor${Date.now()}@test.com`;
        tutorPassword = 'password123';
        
        const response = await fetch(`${API}/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'Test Tutor',
            email: tutorEmail,
            password: tutorPassword,
            role: 'tutor'
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          tutorToken = data.token;
          result.innerHTML = `
            <p class="success">‚úÖ Tutor account created!</p>
            <pre>Email: ${tutorEmail}\nPassword: ${tutorPassword}\nToken saved!</pre>
          `;
        } else {
          result.innerHTML = `<p class="error">‚ùå Error: ${data.message}</p>`;
        }
      } catch (error) {
        result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function createStudentAndProgress() {
      const result = document.getElementById('studentResult');
      result.innerHTML = '<p class="info">Creating student account and progress...</p>';
      
      try {
        // Create student
        const studentEmail = `student${Date.now()}@test.com`;
        const studentResponse = await fetch(`${API}/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'Test Student',
            email: studentEmail,
            password: 'password123',
            role: 'student'
          })
        });
        
        const studentData = await studentResponse.json();
        
        if (!studentData.success) {
          result.innerHTML = `<p class="error">‚ùå Error creating student: ${studentData.message}</p>`;
          return;
        }

        const studentToken = studentData.token;
        let progressText = '';

        // Create multiple progress entries
        const progressEntries = [
          { type: 'test', language: 'mandarin', level: 'level1', score: 15, total: 20, timeSpent: 300 },
          { type: 'quiz', language: 'mandarin', level: 'level1', score: 8, total: 10, timeSpent: 120 },
          { type: 'test', language: 'mandarin', level: 'level2', score: 18, total: 20, timeSpent: 350 },
          { type: 'quiz', language: 'mandarin', level: 'level2', score: 9, total: 10, timeSpent: 150 },
          { type: 'test', language: 'mandarin', level: 'level3', score: 16, total: 20, timeSpent: 400 }
        ];

        for (const entry of progressEntries) {
          const progressResponse = await fetch(`${API}/progress`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${studentToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(entry)
          });
          
          const progressData = await progressResponse.json();
          if (progressData.success) {
            progressText += `‚úì ${entry.type} - ${entry.level} - ${Math.round((entry.score/entry.total)*100)}%\n`;
          } else {
            progressText += `‚úó Failed: ${entry.type} - ${entry.level}\n`;
          }
        }

        result.innerHTML = `
          <p class="success">‚úÖ Student created with progress!</p>
          <pre>Email: ${studentEmail}\nPassword: password123\n\nProgress Added:\n${progressText}</pre>
        `;
      } catch (error) {
        result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function loginTutor() {
      const result = document.getElementById('loginResult');
      
      if (!tutorEmail) {
        result.innerHTML = '<p class="error">‚ùå Please create tutor account first (Step 1)</p>';
        return;
      }

      result.innerHTML = '<p class="info">Logging in as tutor...</p>';
      
      try {
        const response = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: tutorEmail,
            password: tutorPassword
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          tutorToken = data.token;
          localStorage.setItem('token', tutorToken);
          localStorage.setItem('user', JSON.stringify(data.data));
          
          result.innerHTML = `
            <p class="success">‚úÖ Logged in as tutor!</p>
            <pre>Token saved to localStorage\nReady to view dashboard</pre>
            <p><a href="tutor-dashboard.html" target="_blank">‚Üí Open Tutor Dashboard</a></p>
          `;
        } else {
          result.innerHTML = `<p class="error">‚ùå Login failed: ${data.message}</p>`;
        }
      } catch (error) {
        result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function checkDashboard() {
      const result = document.getElementById('dashboardResult');
      
      if (!tutorToken) {
        result.innerHTML = '<p class="error">‚ùå Please login as tutor first (Step 3)</p>';
        return;
      }

      result.innerHTML = '<p class="info">Fetching dashboard data...</p>';
      
      try {
        // Get analytics
        const analyticsResponse = await fetch(`${API}/tutor/analytics`, {
          headers: { 'Authorization': `Bearer ${tutorToken}` }
        });
        const analyticsData = await analyticsResponse.json();

        // Get students
        const studentsResponse = await fetch(`${API}/tutor/students`, {
          headers: { 'Authorization': `Bearer ${tutorToken}` }
        });
        const studentsData = await studentsResponse.json();

        result.innerHTML = `
          <p class="success">‚úÖ Dashboard data retrieved!</p>
          <h3>Analytics:</h3>
          <pre>${JSON.stringify(analyticsData.data, null, 2)}</pre>
          <h3>Students (${studentsData.count}):</h3>
          <pre>${JSON.stringify(studentsData.data, null, 2)}</pre>
          <p><a href="tutor-dashboard.html" target="_blank"><strong>‚Üí Open Tutor Dashboard to see this live</strong></a></p>
        `;
      } catch (error) {
        result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
