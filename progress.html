<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#4a9d6f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="description" content="Track your Chinese learning progress">
  <title>Progress Dashboard - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">LangTutor</div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
          ‚ò∞
        </button>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html#home" class="nav-link" onclick="closeMobileMenu()">Home</a></li>
          <li><a href="quiz-select.html" class="nav-link">Quizzes</a></li>
          <li><a href="test-select.html" class="nav-link">Tests</a></li>
          <li><a href="flashcard-select.html" class="nav-link">Flashcards</a></li>
          <li><a href="progress.html" class="nav-link">Progress</a></li>
          <li><a href="resources.html" class="nav-link">Resources</a></li>
        </ul>
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
      </div>
    </div>
  </nav>

  <section class="practice">
    <div class="container">
      <div class="progress-header">
        <h2>Progress Dashboard</h2>
        <p class="section-subtitle">Track learning progress by level and category</p>
      </div>

      <!-- Summary Stats -->
      <div class="progress-summary" id="summaryStats">
        <div class="summary-card">
          <div class="summary-icon">üéØ</div>
          <div class="summary-content">
            <div class="summary-value" id="totalQuizzes">0</div>
            <div class="summary-label">Quizzes Taken</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">üìä</div>
          <div class="summary-content">
            <div class="summary-value" id="avgScore">0%</div>
            <div class="summary-label">Average Score</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">‚≠ê</div>
          <div class="summary-content">
            <div class="summary-value" id="bestScore">0%</div>
            <div class="summary-label">Best Score</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">üìÖ</div>
          <div class="summary-content">
            <div class="summary-value" id="lastActivity">Never</div>
            <div class="summary-label">Last Practice</div>
          </div>
        </div>
      </div>

      <!-- Progress by Level -->
      <div class="progress-levels" id="progressLevels">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Chinese Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <script src="app.js"></script>
  <script>
    async function loadProgress() {
      console.log('Loading progress from database...');
      
      // Check authentication
      if (!AuthService.isAuthenticated()) {
        document.querySelector('.practice').innerHTML = `
          <div class="container">
            <div class="card" style="text-align: center; padding: 40px;">
              <h3>‚ö†Ô∏è Login Required</h3>
              <p>You must be logged in to view your progress.</p>
              <a href="login.html?redirect=progress.html" class="btn btn-primary" style="margin-top: 20px;">Login Now</a>
            </div>
          </div>
        `;
        return;
      }

      try {
        // Fetch progress from database
        const result = await ProgressService.getProgress();
        console.log('Progress data from database:', result);
        
        const progressData = result.data || [];
        
        if (progressData.length === 0) {
          document.getElementById('progressLevels').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìö</div>
              <h3>No progress yet</h3>
              <p>Start taking quizzes to see your progress here</p>
              <a href="quiz-select.html" class="btn btn-primary" style="margin-top: 20px;">Take Your First Quiz</a>
            </div>
          `;
          return;
        }
        
        // Calculate summary statistics
        const quizzes = progressData.filter(p => p.type === 'quiz');
        const totalQuizzes = quizzes.length;
        const allScores = quizzes.map(p => p.percentage);
        const avgScore = allScores.length > 0 ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : 0;
        const bestScore = allScores.length > 0 ? Math.max(...allScores) : 0;
        
        // Get last activity date
        const lastActivityDate = progressData.length > 0 ? 
          new Date(Math.max(...progressData.map(p => new Date(p.completedAt).getTime()))) : null;
        const lastActivity = lastActivityDate ? formatLastActivity(lastActivityDate) : 'Never';
        
        // Update summary cards
        document.getElementById('totalQuizzes').textContent = totalQuizzes;
        document.getElementById('avgScore').textContent = avgScore + '%';
        document.getElementById('bestScore').textContent = bestScore + '%';
        document.getElementById('lastActivity').textContent = lastActivity;
        
        // Color code average score
        const avgScoreEl = document.getElementById('avgScore');
        if (avgScore >= 80) {
          avgScoreEl.style.color = 'var(--success)';
        } else if (avgScore >= 60) {
          avgScoreEl.style.color = 'var(--warning)';
        } else if (avgScore > 0) {
          avgScoreEl.style.color = 'var(--error)';
        }
        
        // Group progress by level and category
        const groupedProgress = groupProgressData(quizzes);
        displayGroupedProgress(groupedProgress);
        
      } catch (error) {
        console.error('Error loading progress:', error);
        document.querySelector('.practice').innerHTML = `
          <div class="container">
            <div class="card" style="text-align: center; padding: 40px;">
              <h3>‚ùå Error Loading Progress</h3>
              <p>${error.message}</p>
              <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">Retry</button>
            </div>
          </div>
        `;
      }
    }
    
    function formatLastActivity(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 60) return 'Just now';
      if (diffHours < 24) return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function groupProgressData(quizzes) {
      const grouped = {};
      
      quizzes.forEach(quiz => {
        const level = quiz.level || 'unknown';
        const category = quiz.category || 'general';
        
        if (!grouped[level]) {
          grouped[level] = {};
        }
        if (!grouped[level][category]) {
          grouped[level][category] = [];
        }
        
        grouped[level][category].push(quiz);
      });
      
      return grouped;
    }
    
    function displayGroupedProgress(groupedData) {
      const container = document.getElementById('progressLevels');
      const levelOrder = ['newbie', 'level1', 'level2', 'level3', 'sjkc'];
      const levelNames = {
        'newbie': 'Newbie',
        'level1': 'Level 1',
        'level2': 'Level 2',
        'level3': 'Level 3',
        'sjkc': 'SJKC'
      };
      const categoryNames = {
        'general': 'General',
        'text': 'Text',
        'hanyupinyin': 'Hanyu Pinyin',
        'extravocab': 'Extra Vocab'
      };
      
      let html = '';
      
      // Sort levels by predefined order
      const sortedLevels = Object.keys(groupedData).sort((a, b) => {
        const indexA = levelOrder.indexOf(a);
        const indexB = levelOrder.indexOf(b);
        if (indexA === -1 && indexB === -1) return 0;
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        return indexA - indexB;
      });
      
      sortedLevels.forEach(level => {
        const categories = groupedData[level];
        const levelName = levelNames[level] || level.charAt(0).toUpperCase() + level.slice(1);
        
        html += `<div class="level-group">`;
        html += `<h3 class="level-group-title">${levelName}</h3>`;
        html += `<div class="category-grid">`;
        
        Object.keys(categories).forEach(category => {
          const quizzes = categories[category];
          const categoryName = categoryNames[category] || category.charAt(0).toUpperCase() + category.slice(1);
          
          // Calculate stats
          const attempts = quizzes.length;
          const scores = quizzes.map(q => q.percentage);
          const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
          const lastAttempt = quizzes[0]; // Assuming sorted by date (newest first)
          const lastScore = lastAttempt.percentage;
          const lastDate = new Date(lastAttempt.completedAt);
          
          // Determine performance status
          let performanceClass = '';
          let performanceLabel = '';
          if (avgScore >= 80) {
            performanceClass = 'strong';
            performanceLabel = 'Strong';
          } else if (avgScore >= 60) {
            performanceClass = 'average';
            performanceLabel = 'Average';
          } else {
            performanceClass = 'weak';
            performanceLabel = 'Needs Practice';
          }
          
          html += `
            <div class="category-card ${performanceClass}">
              <div class="category-header">
                <h4 class="category-title">${categoryName}</h4>
                <span class="performance-badge ${performanceClass}">${performanceLabel}</span>
              </div>
              
              <div class="category-stats">
                <div class="stat-row">
                  <span class="stat-label">Quizzes taken:</span>
                  <span class="stat-value">${attempts}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Average score:</span>
                  <span class="stat-value stat-highlight">${avgScore}%</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Last attempt:</span>
                  <span class="stat-value">${lastScore}%</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Last practiced:</span>
                  <span class="stat-value stat-date">${formatLastActivity(lastDate)}</span>
                </div>
              </div>
              
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${avgScore}%"></div>
              </div>
              
              <a href="quiz-select.html" class="practice-again-btn">Practice Again</a>
            </div>
          `;
        });
        
        html += `</div></div>`;
      });
      
      container.innerHTML = html;
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.toggle('active');
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.remove('active');
    }

    // Load progress on page load
    document.addEventListener('DOMContentLoaded', loadProgress);
  </script>

</body>
</html>
