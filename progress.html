
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Track your Mandarin learning progress and achievements.">
  <title>My Progress - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="welcome-page">
  <!-- Header Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo" aria-label="Chinese Learning Platform">‰∏≠ÊñáÁªÉ‰π†</div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mobileMenu">
          <span class="menu-icon">‚ò∞</span>
        </button>
        <ul class="nav-links" id="mobileMenu" role="menubar">
          <li role="none"><a href="index.html" class="nav-link" onclick="closeMobileMenu()" role="menuitem">Home</a></li>
          <li role="none"><a href="quiz-select.html" class="nav-link" role="menuitem">Quizzes</a></li>
          <li role="none"><a href="test-select.html" class="nav-link" role="menuitem">Tests</a></li>
          <li role="none"><a href="flashcard-select.html" class="nav-link" role="menuitem">Flashcards</a></li>
          <li role="none"><a href="progress.html" class="nav-link active" role="menuitem">Progress</a></li>
          <li role="none"><a href="resources.html" class="nav-link" role="menuitem">Resources</a></li>
        </ul>
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode" title="Switch color scheme">üåô</button>
      </div>
    </div>
  </nav>




  <!-- Dashboard Section -->
  <section class="dashboard-section" id="dashboard">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">My Progress Dashboard</h2>
        <p class="section-subtitle">Track your learning, streaks, and achievements below.</p>
      </div>
      <div id="progressContent">
        <div class="loading">Loading your progress...</div>
      </div>
    </div>
  </section>

  <footer class="welcome-footer">
    <p>&copy; 2026 Chinese Learning Platform. All rights reserved.</p>
    <p style="margin-top: var(--spacing-sm); font-size: 0.9rem;">Professional Mandarin instruction with Pushpavalli, M.Ed</p>
  </footer>

  <!-- Ensure auth-service.js is loaded first for AuthService global -->
  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <script src="app.js"></script>
  <script>
    async function renderProgress() {
      const container = document.getElementById('progressContent');
      if (!AuthService.isAuthenticated()) {
        container.innerHTML = `<div class="card"><h3>Login Required</h3><p>Please <a href='login.html?redirect=progress.html'>log in</a> to view your progress.</p></div>`;
        return;
      }
      // Debug log for student role
      const user = AuthService.getCurrentUser();
      if (user) {
        console.log('[DEBUG] User role:', user.role);
      }
      try {
        const [progress, stats, streak] = await Promise.all([
          ProgressService.getProgress(),
          ProgressService.getStats(),
          ProgressService.getStreak()
        ]);
        if (!progress.success) throw new Error(progress.message || 'Could not load progress');
        const data = progress.data || [];
        const stat = stats && stats.success ? stats.data : {};
        const streakData = streak && streak.success ? streak.data : { current: 0, best: 0 };
        let html = `<div class='student-detail'>`;
        html += `<h2 style='text-align:center;'>Welcome, ${AuthService.getCurrentUser().name}</h2>`;
        html += `<div class='progress-grid'>`;
        html += `<div class='progress-item'><h4>üî• Current Streak</h4><div class='value'>${streakData.current}</div></div>`;
        html += `<div class='progress-item'><h4>üèÜ Best Streak</h4><div class='value'>${streakData.best}</div></div>`;
        html += `<div class='progress-item'><h4>üìù Total Tests</h4><div class='value'>${stat.totalTests || 0}</div></div>`;
        html += `<div class='progress-item'><h4>üéØ Total Quizzes</h4><div class='value'>${stat.totalQuizzes || 0}</div></div>`;
        html += `<div class='progress-item'><h4>‚≠ê Average Score</h4><div class='value'>${stat.averageScore || 0}%</div></div>`;
        html += `<div class='progress-item'><h4>üéñÔ∏è Best Score</h4><div class='value'>${stat.bestScore || 0}%</div></div>`;
        html += `</div>`;
        if (stat.byLevel && Object.keys(stat.byLevel).length > 0) {
          html += `<h3 style='margin-top:2rem;'>Progress by Level</h3><div class='progress-grid'>`;
          html += Object.values(stat.byLevel).map(level => `
            <div class='progress-item'>
              <h4>${level.level.toUpperCase()}</h4>
              <div class='value'>${level.averageScore}%</div>
              <p style='font-size:0.8rem;color:var(--text-secondary);'>${level.tests + level.quizzes} activities</p>
            </div>
          `).join('');
          html += `</div>`;
        }
        if (data.length > 0) {
          html += `<h3 style='margin-top:2rem;'>Recent Activity</h3><div class='activity-list'>`;
          html += data.sort((a,b)=>new Date(b.completedAt)-new Date(a.completedAt)).slice(0,10).map(activity => `
            <div class='activity-item'>
              <div><strong>${activity.type === 'test' ? 'üìù Test' : 'üéØ Quiz'}</strong> - ${activity.level.toUpperCase()} - <span style='color:${activity.percentage >= 80 ? '#27ae60' : activity.percentage >= 60 ? '#f39c12' : '#e74c3c'}'>${activity.percentage}%</span></div>
              <div style='color:var(--text-secondary);font-size:0.9rem;'>${new Date(activity.completedAt).toLocaleDateString()}</div>
            </div>
          `).join('');
          html += `</div>`;
        }
        html += `</div>`;
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div class='empty-state'><h3>Error</h3><p>${e.message}</p></div>`;
      }
    }
    window.addEventListener('DOMContentLoaded', () => {
      renderProgress();
      if (window.DarkMode && typeof DarkMode.init === 'function') {
        DarkMode.init();
      }
    });
    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const toggle = document.querySelector('.mobile-menu-toggle');
      const isExpanded = menu.classList.toggle('active');
      toggle.setAttribute('aria-expanded', isExpanded);
    }
    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const toggle = document.querySelector('.mobile-menu-toggle');
      menu.classList.remove('active');
      toggle.setAttribute('aria-expanded', 'false');
    }
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('mobileMenu');
      const toggle = document.querySelector('.mobile-menu-toggle');
      if (menu && !menu.contains(event.target) && !toggle.contains(event.target)) {
        closeMobileMenu();
      }
    });
  </script>
</body>
</html>
