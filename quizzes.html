<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#4a9d6f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="description" content="Quizzes - Chinese Language Tutor">
  <title>Quizzes - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">LangTutor</div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
          ‚ò∞
        </button>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html#home" class="nav-link" onclick="closeMobileMenu()">Home</a></li>
          <li><a href="quiz-select.html" class="nav-link">Quizzes</a></li>
          <li><a href="test-select.html" class="nav-link">Tests</a></li>
          <li><a href="flashcards.html" class="nav-link">Flashcards</a></li>
          <li><a href="progress.html" class="nav-link">Progress</a></li>
          <li><a href="resources.html" class="nav-link">Resources</a></li>
          <li><a href="writing.html" class="nav-link">Writing Practice</a></li>
        </ul>
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
      </div>
    </div>
  </nav>

  <section class="practice" id="practice">
    <div class="container">
      <h2>Quizzes</h2>
      <p class="section-subtitle" id="subtitle">Loading...</p>

      <div id="quizContainer"></div>

      <p><a href="quiz-select.html" class="btn btn-primary">Back to Selection</a></p>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <!-- Load dependencies in correct order -->
  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <script src="app.js"></script>
  <script src="quizzes.js"></script>
  <script>
    // Verify all required services are loaded
    if (typeof AuthService === 'undefined') {
      alert('ERROR: AuthService not loaded. Please refresh the page.');
      throw new Error('AuthService not loaded');
    }
    if (typeof ProgressService === 'undefined') {
      alert('ERROR: ProgressService not loaded. Please refresh the page.');
      throw new Error('ProgressService not loaded');
    }
    console.log('‚úì All services loaded successfully');
  </script>
  <script>
    let currentLanguage = '';
    let currentLevel = '';
    let quizAnswers = {}; // Track which quizzes were answered correctly
    let startTime = Date.now();

    // Load quiz data based on URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!AuthService.isAuthenticated()) {
        document.getElementById('quizContainer').innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <h3>‚ö†Ô∏è Login Required</h3>
            <p>You must be logged in to take quizzes and save your progress.</p>
            <a href="login.html?redirect=quizzes.html${window.location.search}" class="btn btn-primary" style="margin-top: 20px;">Login Now</a>
          </div>
        `;
        return;
      }

      const user = AuthService.getCurrentUser();
      console.log('‚úì User authenticated:', user.name);

      const params = new URLSearchParams(window.location.search);
      currentLanguage = params.get('language');
      currentLevel = params.get('level');
      
      if (currentLanguage && currentLevel) {
        loadQuiz(currentLanguage, currentLevel);
      } else {
        document.getElementById('quizContainer').innerHTML = '<p>No quiz selected. <a href="quiz-select.html">Go back to selection</a></p>';
      }
    });

    const quizData = {
      newbie: {
        mandarin: [
          {
            id: 1,
            title: 'Mandarin Basics',
            question: 'What is the pinyin for "‰Ω†"?',
            options: [{ text: 'n«ê', correct: true }, { text: 'w«í', correct: false }, { text: 'tƒÅ', correct: false }]
          },
          {
            id: 2,
            title: 'Numbers',
            question: 'Which character means "one"?',
            options: [{ text: '‰∏Ä', correct: true }, { text: '‰∫å', correct: false }, { text: '‰∏â', correct: false }]
          }
        ]
      },
      level1: {
        mandarin: [
          {
            id: 1,
            title: 'Mandarin Characters',
            question: 'Which pinyin corresponds to the character "‰∏Ä"?',
            options: [{ text: 'yi', correct: true }, { text: 'er', correct: false }, { text: 'san', correct: false }]
          },
          {
            id: 2,
            title: 'Common Phrases',
            question: 'What does "Ë∞¢Ë∞¢" mean?',
            options: [{ text: 'Thank you', correct: true }, { text: 'Hello', correct: false }, { text: 'Goodbye', correct: false }]
          }
        ]
      },
      level2: {
        mandarin: [
          {
            id: 1,
            title: 'Intermediate Vocabulary',
            question: 'What does "Â≠¶Ê†°" mean?',
            options: [{ text: 'School', correct: true }, { text: 'Hospital', correct: false }, { text: 'Library', correct: false }]
          },
          {
            id: 2,
            title: 'Sentence Structure',
            question: 'Which word order is correct in Mandarin?',
            options: [{ text: 'Subject + Verb + Object', correct: true }, { text: 'Verb + Subject + Object', correct: false }, { text: 'Object + Verb + Subject', correct: false }]
          }
        ]
      },
      level3: {
        mandarin: [
          {
            id: 1,
            title: 'Advanced Pinyin',
            question: 'Which pinyin (with tones) is correct for "‰Ω†Â•Ω"?',
            options: [{ text: 'n«êh«éo', correct: true }, { text: 'n√¨h√†o', correct: false }, { text: 'n√≠hƒÅo', correct: false }]
          },
          {
            id: 2,
            title: 'Complex Characters',
            question: 'What is the correct stroke order principle?',
            options: [{ text: 'Top to bottom, left to right', correct: true }, { text: 'Right to left, bottom to top', correct: false }]
          }
        ]
      },
      level4: {
        mandarin: []
      },
      level5: {
        mandarin: []
      },
      level6: {
        mandarin: []
      },
      sjkc: {
        mandarin: [
          {
            id: 1,
            title: 'SJKC - Advanced Characters',
            question: 'What is the meaning of "ÂçéÊñá"?',
            options: [{ text: 'Chinese language', correct: true }, { text: 'English language', correct: false }, { text: 'Mathematics', correct: false }]
          },
          {
            id: 2,
            title: 'SJKC - Idioms',
            question: 'What does the idiom "‰∏ÄÁü≥‰∫åÈ∏ü" mean?',
            options: [{ text: 'Kill two birds with one stone', correct: true }, { text: 'Birds of a feather', correct: false }, { text: 'Early bird', correct: false }]
          }
        ]
      }
    };

    function loadQuiz(language, level) {
      const quizzes = quizData[level]?.[language] || [];
      const levelNames = {
        'newbie': 'Newbie',
        'level1': 'Level 1',
        'level2': 'Level 2',
        'level3': 'Level 3',
        'level4': 'Level 4',
        'level5': 'Level 5',
        'level6': 'Level 6',
        'sjkc': 'SJKC'
      };
      const levelName = levelNames[level] || level;
      document.getElementById('subtitle').textContent = `${language.charAt(0).toUpperCase() + language.slice(1)} - ${levelName}`;
      
      if (quizzes.length === 0) {
        document.getElementById('quizContainer').innerHTML = '<p>No quizzes available for this selection yet. More content coming soon! <a href="quiz-select.html">Try another selection</a></p>';
        return;
      }

      let html = '<div class="quiz-grid">';
      quizzes.forEach(quiz => {
        html += `
          <div class="card">
            <h3>${quiz.title} (${levelName})</h3>
            <p class="question">${quiz.question}</p>
            <div class="options">
              ${quiz.options.map((opt, idx) => `
                <button class="option-btn" onclick="answerQuiz(${quiz.id}, ${opt.correct})">${opt.text}</button>
              `).join('')}
            </div>
            <p id="result-${quiz.id}" class="feedback"></p>
          </div>
        `;
      });
      html += '</div>';
      html += '<div style="text-align: center; margin-top: 30px;"><button id="submitQuizzes" class="btn btn-primary" onclick="submitAllQuizzes()" style="display: none;">Submit All Quizzes</button></div>';
      document.getElementById('quizContainer').innerHTML = html;
    }

    async function answerQuiz(quizId, isCorrect) {
      const resultElement = document.getElementById(`result-${quizId}`);
      if (!resultElement) return;
      
      // Store answer
      quizAnswers[quizId] = isCorrect;
      
      if (isCorrect) {
        resultElement.textContent = '‚úÖ Correct! Great job!';
        resultElement.className = 'feedback success';
      } else {
        resultElement.textContent = '‚ùå Not quite right. Try again!';
        resultElement.className = 'feedback error';
      }
      
      // Check if all quizzes answered
      const totalQuizzes = quizData[currentLevel]?.[currentLanguage]?.length || 0;
      if (Object.keys(quizAnswers).length === totalQuizzes) {
        document.getElementById('submitQuizzes').style.display = 'inline-block';
      }
    }

    async function submitAllQuizzes() {
      const totalQuizzes = Object.keys(quizAnswers).length;
      const correctCount = Object.values(quizAnswers).filter(answer => answer === true).length;
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üíæ SAVING QUIZ RESULTS TO DATABASE');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('Quiz Details:', {
        type: 'quiz',
        language: currentLanguage,
        level: currentLevel,
        score: `${correctCount}/${totalQuizzes}`,
        percentage: `${Math.round((correctCount/totalQuizzes)*100)}%`,
        timeSpent: `${timeSpent}s`
      });

      try {
        const result = await ProgressService.saveScore(
          'quiz',
          currentLanguage,
          currentLevel,
          correctCount,
          totalQuizzes,
          timeSpent
        );
        
        console.log('‚úÖ SUCCESS: Quiz results saved to database');
        console.log('Result:', result);
        
        alert(`Quiz Complete! üéâ\n\nScore: ${correctCount}/${totalQuizzes} (${Math.round((correctCount/totalQuizzes)*100)}%)\n\nYour progress has been saved to the database.`);
        
        // Disable submit button
        document.getElementById('submitQuizzes').style.display = 'none';
        
      } catch (error) {
        console.error('‚ùå FAILED: Could not save quiz results');
        console.error('Error:', error.message);
        
        alert(
          `‚ö†Ô∏è FAILED TO SAVE YOUR QUIZ RESULTS\n\n` +
          `Your score: ${Math.round((correctCount/totalQuizzes)*100)}%\n\n` +
          `Error: ${error.message}\n\n` +
          `Please check your internet connection and try again.`
        );
      }
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.toggle('active');
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.remove('active');
    }
  </script>
  <script src="app.js"></script>

</body>
</html>