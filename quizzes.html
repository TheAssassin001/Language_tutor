<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#4a9d6f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="description" content="Quizzes - Chinese Language Tutor">
  <title>Quizzes - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">LangTutor</div>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html#home" class="nav-link" onclick="closeMobileMenu()">Home</a></li>
          <li><a href="quiz-select.html" class="nav-link">Quizzes</a></li>
          <li><a href="test-select.html" class="nav-link">Tests</a></li>
          <li><a href="flashcard-select.html" class="nav-link">Flashcards</a></li>
          <li><a href="progress.html" class="nav-link">Progress</a></li>
          <li><a href="resources.html" class="nav-link">Resources</a></li>
          <li><a href="writing.html" class="nav-link">Writing Practice</a></li>
        </ul>
        <div class="nav-controls">
          <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
            ‚ò∞
          </button>
        </div>
      </div>
    </div>
    <div class="nav-overlay" id="navOverlay" onclick="closeMobileMenu()"></div>
  </nav>

  <section class="practice" id="practice">
    <div class="container">
      <h2>Quizzes</h2>
      <p class="section-subtitle" id="subtitle">Loading...</p>

      <div id="quizContainer"></div>

      <p><a href="quiz-select.html" class="btn btn-primary">Back to Selection</a></p>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <!-- Load dependencies in correct order -->
  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <script src="app.js"></script>
  <script src="quizzes.js"></script>
  <script>
    // Verify all required services are loaded
    if (typeof AuthService === 'undefined') {
      alert('ERROR: AuthService not loaded. Please refresh the page.');
      throw new Error('AuthService not loaded');
    }
    if (typeof ProgressService === 'undefined') {
      alert('ERROR: ProgressService not loaded. Please refresh the page.');
      throw new Error('ProgressService not loaded');
    }
    console.log('‚úì All services loaded successfully');
  </script>
  <script>
    let currentLanguage = '';
    let currentLevel = '';
    let currentCategory = '';
    let quizAnswers = {}; // Track which quizzes were answered correctly
    let startTime = Date.now();

    // Load quiz data based on URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!AuthService.isAuthenticated()) {
        document.getElementById('quizContainer').innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <h3>‚ö†Ô∏è Login Required</h3>
            <p>You must be logged in to take quizzes and save your progress.</p>
            <a href="login.html?redirect=quizzes.html${window.location.search}" class="btn btn-primary" style="margin-top: 20px;">Login Now</a>
          </div>
        `;
        return;
      }

      const user = AuthService.getCurrentUser();
      console.log('‚úì User authenticated:', user.name);

      const params = new URLSearchParams(window.location.search);
      currentLanguage = params.get('language');
      currentLevel = params.get('level');
      currentCategory = params.get('category') || '';
      
      if (currentLanguage && currentLevel) {
        loadQuiz(currentLanguage, currentLevel);
      } else {
        document.getElementById('quizContainer').innerHTML = '<p>No quiz selected. <a href="quiz-select.html">Go back to selection</a></p>';
      }
    });

    // Utility function to shuffle array
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Auto-generate quiz questions from FlashcardData
    function generateQuizQuestions(level, category = null) {
      let flashcards = [];
      
      // Get flashcards based on level and category
      if (level === 'newbie') {
        flashcards = FlashcardData.mandarin.newbie || [];
      } else if (level === 'level1' && category) {
        flashcards = FlashcardData.mandarin.level1?.[category] || [];
      } else if (level === 'level2' && category) {
        flashcards = FlashcardData.mandarin.level2?.[category] || [];
      }
      
      if (flashcards.length === 0) {
        return [];
      }
      
      // Shuffle flashcards and select 10-15 for quiz
      const numQuestions = Math.min(15, flashcards.length);
      const selectedCards = shuffleArray(flashcards).slice(0, numQuestions);
      
      // Generate questions
      const questions = selectedCards.map((card, index) => {
        // Get wrong answer options from other flashcards
        const otherCards = flashcards.filter(c => c.front !== card.front && c.back !== card.back);
        const wrongAnswers = shuffleArray(otherCards)
          .slice(0, 3)
          .map(c => ({ text: c.back, correct: false }));
        
        // Add correct answer
        const correctAnswer = { text: card.back, correct: true };
        
        // Shuffle all options
        const allOptions = shuffleArray([correctAnswer, ...wrongAnswers]).slice(0, 4);
        
        return {
          id: index + 1,
          question: `What does "${card.front}" mean?`,
          options: allOptions
        };
      });
      
      return questions;
    }

    // Generate quizData on-the-fly
    function getQuizData(level, category = null) {
      if (level === 'newbie') {
        return generateQuizQuestions('newbie');
      } else if ((level === 'level1' || level === 'level2') && category) {
        return generateQuizQuestions(level, category);
      }
      return [];
    }

    function loadQuiz(language, level) {
      // Auto-generate quiz questions from FlashcardData
      let quizzes = getQuizData(level, currentCategory);
      
      const levelNames = {
        'newbie': 'Newbie',
        'level1': 'Level 1',
        'level2': 'Level 2',
        'level3': 'Level 3',
        'level4': 'Level 4',
        'level5': 'Level 5',
        'level6': 'Level 6',
        'sjkc': 'SJKC'
      };
      const categoryNames = {
        'text': 'Text',
        'hanyupinyin': 'Hanyu Pinyin',
        'extravocab': 'Extra Vocab'
      };
      
      const levelName = levelNames[level] || level;
      let subtitleText = `${language.charAt(0).toUpperCase() + language.slice(1)} - ${levelName}`;
      if (currentCategory) {
        subtitleText += ` - ${categoryNames[currentCategory]}`;
      }
      document.getElementById('subtitle').textContent = subtitleText;
      
      if (quizzes.length === 0) {
        document.getElementById('quizContainer').innerHTML = '<p>No quizzes available for this selection yet. More content coming soon! <a href="quiz-select.html">Try another selection</a></p>';
        return;
      }

      let html = '<div class="quiz-grid">';
      quizzes.forEach(quiz => {
        html += `
          <div class="card">
            <p class="question">${quiz.question}</p>
            <div class="options">
              ${quiz.options.map((opt, idx) => `
                <button class="option-btn" onclick="answerQuiz(${quiz.id}, ${opt.correct})">${opt.text}</button>
              `).join('')}
            </div>
            <p id="result-${quiz.id}" class="feedback"></p>
          </div>
        `;
      });
      html += '</div>';
      html += '<div style="text-align: center; margin-top: 30px;"><button id="submitQuizzes" class="btn btn-primary" onclick="submitAllQuizzes()" style="display: none;">Submit All Quizzes</button></div>';
      document.getElementById('quizContainer').innerHTML = html;
    }

    async function answerQuiz(quizId, isCorrect) {
      const resultElement = document.getElementById(`result-${quizId}`);
      if (!resultElement) return;
      
      // Store answer
      quizAnswers[quizId] = isCorrect;
      
      if (isCorrect) {
        resultElement.textContent = '‚úÖ Correct! Great job!';
        resultElement.className = 'feedback success';
      } else {
        resultElement.textContent = '‚ùå Not quite right. Try again!';
        resultElement.className = 'feedback error';
      }
      
      // Check if all quizzes answered
      let quizzes = quizData[currentLevel]?.[currentLanguage] || [];
      
      // Handle category structure for level1 and level2
      if ((currentLevel === 'level1' || currentLevel === 'level2') && currentCategory) {
        if (typeof quizzes === 'object' && !Array.isArray(quizzes)) {
          quizzes = quizzes[currentCategory] || [];
        }
      }
      
      const totalQuizzes = quizzes.length;
      if (Object.keys(quizAnswers).length === totalQuizzes) {
        document.getElementById('submitQuizzes').style.display = 'inline-block';
      }
    }

    async function submitAllQuizzes() {
      const totalQuizzes = Object.keys(quizAnswers).length;
      const correctCount = Object.values(quizAnswers).filter(answer => answer === true).length;
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üíæ SAVING QUIZ RESULTS TO DATABASE');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('Quiz Details:', {
        type: 'quiz',
        language: currentLanguage,
        level: currentLevel,
        score: `${correctCount}/${totalQuizzes}`,
        percentage: `${Math.round((correctCount/totalQuizzes)*100)}%`,
        timeSpent: `${timeSpent}s`
      });

      try {
        const result = await ProgressService.saveScore(
          'quiz',
          currentLanguage,
          currentLevel,
          correctCount,
          totalQuizzes,
          timeSpent
        );
        
        console.log('‚úÖ SUCCESS: Quiz results saved to database');
        console.log('Result:', result);
        
        // Show results on the page
        const percentage = Math.round((correctCount/totalQuizzes)*100);
        document.getElementById('quizContainer').innerHTML = `
          <div class="card" style="text-align: center; padding: 40px; max-width: 600px; margin: 0 auto;">
            <h2 style="color: var(--accent); margin-bottom: 20px;">üéâ Quiz Complete!</h2>
            <div style="font-size: 48px; font-weight: bold; color: ${percentage >= 70 ? 'var(--success)' : 'var(--error)'}; margin: 20px 0;">
              ${percentage}%
            </div>
            <p style="font-size: 20px; margin: 15px 0;">Score: ${correctCount} out of ${totalQuizzes}</p>
            <p style="font-size: 16px; color: #666; margin: 10px 0;">Time: ${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s</p>
            <p style="margin-top: 30px; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
              ‚úÖ Your progress has been saved!
            </p>
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <a href="quiz-select.html" class="btn btn-primary" style="display: inline-block !important; padding: 12px 24px !important; text-decoration: none !important; cursor: pointer !important; position: relative !important; z-index: 999 !important;">Take Another Quiz</a>
              <a href="progress.html" class="btn btn-secondary" style="display: inline-block !important; padding: 12px 24px !important; text-decoration: none !important; cursor: pointer !important; position: relative !important; z-index: 999 !important;">View Progress</a>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('‚ùå FAILED: Could not save quiz results');
        console.error('Error:', error.message);
        
        // Show error results on the page
        const percentage = Math.round((correctCount/totalQuizzes)*100);
        document.getElementById('quizContainer').innerHTML = `
          <div class="card" style="text-align: center; padding: 40px; max-width: 600px; margin: 0 auto;">
            <h2 style="color: var(--error); margin-bottom: 20px;">‚ö†Ô∏è Quiz Complete (Not Saved)</h2>
            <div style="font-size: 48px; font-weight: bold; color: ${percentage >= 70 ? 'var(--success)' : 'var(--error)'}; margin: 20px 0;">
              ${percentage}%
            </div>
            <p style="font-size: 20px; margin: 15px 0;">Score: ${correctCount} out of ${totalQuizzes}</p>
            <p style="font-size: 16px; color: #666; margin: 10px 0;">Time: ${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s</p>
            <p style="margin-top: 30px; padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">
              ‚ùå Failed to save: ${error.message}
            </p>
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <a href="quiz-select.html" class="btn btn-primary" style="display: inline-block !important; padding: 12px 24px !important; text-decoration: none !important; cursor: pointer !important; position: relative !important; z-index: 999 !important;">Take Another Quiz</a>
              <a href="progress.html" class="btn btn-secondary" style="display: inline-block !important; padding: 12px 24px !important; text-decoration: none !important; cursor: pointer !important; position: relative !important; z-index: 999 !important;">View Progress</a>
            </div>
          </div>
        `;
      }
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      menu.classList.toggle('active');
      if (overlay) overlay.classList.toggle('active');
      
      // Prevent body scroll when menu is open
      if (menu.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      menu.classList.remove('active');
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  </script>
  <script src="app.js"></script>

</body>
</html>