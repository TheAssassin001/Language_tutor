<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#4a9d6f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <link rel="icon" href="/icon-192.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <meta name="description" content="Quizzes - Chinese Language Tutor">
  <title>Quizzes - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">LangTutor</div>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html#home" class="nav-link" onclick="closeMobileMenu()">Home</a></li>
          <li><a href="quiz-select.html" class="nav-link">Quizzes</a></li>
          <li><a href="test-select.html" class="nav-link">Tests</a></li>
          <li><a href="flashcard-select.html" class="nav-link">Flashcards</a></li>
          <!-- Progress link removed -->
          <li><a href="resources.html" class="nav-link">Resources</a></li>
          <li><a href="writing.html" class="nav-link">Writing Practice</a></li>
        </ul>
        <div class="nav-controls">
          <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
          <!-- Install button removed -->
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
            ‚ò∞
          </button>
        </div>
      </div>
    </div>
    <div class="nav-overlay" id="navOverlay" onclick="closeMobileMenu()"></div>
  </nav>

  <section class="practice" id="practice">
    <div class="container">
      <h2>Quizzes</h2>
      <p class="section-subtitle" id="subtitle">Loading...</p>

      <div id="quizContainer"></div>

      <p><a href="quiz-select.html" class="btn btn-primary">Back to Selection</a></p>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <!-- Load dependencies in correct order -->
  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <!-- <script src="app.js"></script> -->
  <script src="quizzes.js"></script>
  <script>
    // Verify all required services are loaded
    if (typeof AuthService === 'undefined') {
      alert('ERROR: AuthService not loaded. Please refresh the page.');
      throw new Error('AuthService not loaded');
    }
    if (typeof ProgressService === 'undefined') {
      alert('ERROR: ProgressService not loaded. Please refresh the page.');
      throw new Error('ProgressService not loaded');
    }
    console.log('‚úì All services loaded successfully');
  </script>
  <script>
    let currentLanguage = '';
    let currentLevel = '';
    let currentCategory = '';
    let currentSubcategory = ''; // Track the selected subcategory
    let quizAnswers = {}; // Track which quizzes were answered correctly
    let startTime = Date.now();

    // Load quiz data based on URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!AuthService.isAuthenticated()) {
        document.getElementById('quizContainer').innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <h3>‚ö†Ô∏è Login Required</h3>
            <p>You must be logged in to take quizzes and save your progress.</p>
            <a href="login.html?redirect=quizzes.html${window.location.search}" class="btn btn-primary" style="margin-top: 20px;">Login Now</a>
          </div>
        `;
        return;
      }

      const user = AuthService.getCurrentUser();
      console.log('‚úì User authenticated:', user.name);

      const params = new URLSearchParams(window.location.search);
      currentLanguage = params.get('language');
      currentLevel = params.get('level');
      currentCategory = params.get('category') || '';
      currentSubcategory = params.get('subcategory') || ''; // Get subcategory from URL
      
      if (currentLanguage && currentLevel) {
        loadQuiz(currentLanguage, currentLevel);
      } else {
        document.getElementById('quizContainer').innerHTML = '<p>No quiz selected. <a href="quiz-select.html">Go back to selection</a></p>';
      }
      
      // Add keyboard navigation for quiz buttons
      document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('quiz-option-btn') && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault();
          e.target.click();
        }
      });
    });

    // Utility function to shuffle array
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Auto-generate quiz questions from FlashcardData
    function generateQuizQuestions(level, category = null, subcategory = null) {
      let flashcards = [];
      // Get flashcards based on level, category, and subcategory
      if (level === 'newbie') {
        if (subcategory && FlashcardData.mandarin.newbie[subcategory]) {
          flashcards = FlashcardData.mandarin.newbie[subcategory];
        }
      } else if (level === 'level1' && category && subcategory) {
        if (FlashcardData.mandarin.level1[category] && FlashcardData.mandarin.level1[category][subcategory]) {
          flashcards = FlashcardData.mandarin.level1[category][subcategory];
        }
      } else if (level === 'level2' && category) {
        flashcards = FlashcardData.mandarin.level2?.[category] || [];
      }
      if (!Array.isArray(flashcards) || flashcards.length === 0) {
        return [];
      }
      // Shuffle flashcards and select exactly 10 for quiz
      const numQuestions = Math.min(10, flashcards.length);
      const selectedCards = shuffleArray(flashcards).slice(0, numQuestions);
      // Generate questions
      const questions = selectedCards.map((card, index) => {
        // Get wrong answer options from other flashcards
        const otherCards = flashcards.filter(c => c.front !== card.front && c.back !== card.back);
        const wrongAnswers = shuffleArray(otherCards)
          .slice(0, 3)
          .map(c => ({ text: c.back, correct: false }));
        // Add correct answer
        const correctAnswer = { text: card.back, correct: true };
        // Shuffle all options
        const allOptions = shuffleArray([correctAnswer, ...wrongAnswers]).slice(0, 4);
        return {
          id: index + 1,
          pinyin: card.front,
          chinese: card.audio,
          question: `What does "${card.front}" mean?`,
          options: allOptions
        };
      });
      return questions;
    }

    // Generate quizData on-the-fly
    function getQuizData(level, category = null, subcategory = null) {
      if (level === 'newbie') {
        return generateQuizQuestions('newbie', null, subcategory);
      } else if ((level === 'level1' || level === 'level2') && category) {
        return generateQuizQuestions(level, category, subcategory);
      }
      return [];
    }

    function loadQuiz(language, level) {
      // Auto-generate quiz questions from FlashcardData
      let quizzes = getQuizData(level, currentCategory, currentSubcategory);
      
      const levelNames = {
        'newbie': 'Newbie',
        'level1': 'Level 1',
        'level2': 'Level 2',
        'level3': 'Level 3',
        'level4': 'Level 4',
        'level5': 'Level 5',
        'level6': 'Level 6',
        'sjkc': 'SJKC'
      };
      const categoryNames = {
        'text': 'Text',
        'hanyupinyin': 'Hanyu Pinyin',
        'extravocab': 'Extra Vocab'
      };
      
      const levelName = levelNames[level] || level;
      let subtitleText = `${language.charAt(0).toUpperCase() + language.slice(1)} - ${levelName}`;
      if (currentCategory) {
        subtitleText += ` - ${categoryNames[currentCategory]}`;
      }
      document.getElementById('subtitle').textContent = subtitleText;
      
      if (quizzes.length === 0) {
        document.getElementById('quizContainer').innerHTML = '<p>No quizzes available for this selection yet. More content coming soon! <a href="quiz-select.html">Try another selection</a></p>';
        return;
      }

      let html = '<div class="quiz-list">';
      // Debug info: show number of questions and answers
      html += `<div id="quiz-debug" style="background:#ffeeba;color:#856404;padding:8px 12px;margin-bottom:10px;border-radius:6px;font-size:0.95em;">Debug: <span id='debug-answered'>0</span> / <span id='debug-total'>${quizzes.length}</span> answered</div>`;
      quizzes.forEach((quiz, index) => {
        html += `
          <div class="quiz-card" id="quiz-card-${quiz.id}">
            <div class="quiz-header">
              <div class="quiz-progress-label">Question ${index + 1} / ${quizzes.length}</div>
              <div class="quiz-progress-bar">
                <div class="quiz-progress-fill" style="width: ${((index + 1) / quizzes.length) * 100}%"></div>
              </div>
            </div>
            
            <div class="quiz-question-area">
              <div class="quiz-pinyin">${quiz.pinyin}</div>
              <div class="quiz-chinese">${quiz.chinese}</div>
              <p class="quiz-prompt">Select the correct translation:</p>
            </div>
            
            <div class="quiz-options" role="group" aria-label="Answer options">
              ${quiz.options.map((opt, idx) => `
                <button 
                  class="quiz-option-btn" 
                  onclick="answerQuiz(${quiz.id}, ${opt.correct}, '${opt.text}', ${index + 1}, ${quizzes.length})" 
                  data-quiz-id="${quiz.id}"
                  data-correct="${opt.correct}"
                  data-answer="${opt.text}"
                  aria-label="Option ${String.fromCharCode(65 + idx)}: ${opt.text}"
                  tabindex="0">
                  <span class="option-letter" aria-hidden="true">${String.fromCharCode(65 + idx)}</span>
                  <span class="option-text">${opt.text}</span>
                </button>
              `).join('')}
            </div>
            
            <div id="feedback-${quiz.id}" class="quiz-feedback"></div>
          </div>
        `;
      });
      html += '</div>';
      // Add submit button container (hidden/disabled until all questions are answered)
      html += '<div class="quiz-submit-container"><button id="submitQuizzes" class="btn btn-primary btn-large" disabled aria-disabled="true" style="opacity:0.6;pointer-events:none;">Submit Quiz</button></div>';
      document.getElementById('quizContainer').innerHTML = html;
      // Attach click handler to the submit button after it is in the DOM
      setTimeout(function() {
        const submitBtn = document.getElementById('submitQuizzes');
        if (submitBtn) {
          // Ensure only one listener
          submitBtn.removeEventListener('click', submitAllQuizzes);
          submitBtn.addEventListener('click', function(e) {
            // Prevent accidental clicks when disabled
            if (submitBtn.disabled) {
              e.preventDefault();
              return;
            }
            submitAllQuizzes();
          });
        }
      }, 0);
    }

    async function answerQuiz(quizId, isCorrect, selectedAnswer, currentQuestion, totalQuestions) {
const feedbackElement = document.getElementById(`feedback-${quizId}`);
    const quizCard = document.getElementById(`quiz-card-${quizId}`);
    if (!feedbackElement || !quizCard) return;
    
    // Prevent multiple answers
    if (quizAnswers[quizId] !== undefined) return;
    
    // Store answer
    quizAnswers[quizId] = isCorrect;
    console.log('DEBUG: answerQuiz stored', { quizId, isCorrect, selectedAnswer });
    // Update debug info (after storing)
    if (document.getElementById('debug-answered')) {
      document.getElementById('debug-answered').textContent = Object.keys(quizAnswers).length;
    }
      
      // Find correct answer for display
      const buttons = quizCard.querySelectorAll('.quiz-option-btn');
      let correctAnswer = '';
      
      buttons.forEach(btn => {
        const isCorrectBtn = btn.getAttribute('data-correct') === 'true';
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        
        // Highlight correct answer
        if (isCorrectBtn) {
          correctAnswer = btn.getAttribute('data-answer');
          btn.classList.add('correct');
          btn.setAttribute('aria-label', btn.getAttribute('aria-label') + ' - Correct answer');
        }
        
        // Mark user's incorrect selection
        if (!isCorrect && btn.getAttribute('data-answer') === selectedAnswer) {
          btn.classList.add('incorrect');
          btn.setAttribute('aria-label', btn.getAttribute('aria-label') + ' - Your selection (incorrect)');
        }
      });
      
      // Show feedback with correct answer for incorrect responses
      if (isCorrect) {
        feedbackElement.innerHTML = `
          <span class="feedback-icon" aria-hidden="true">‚úì</span> 
          <span class="feedback-text">Correct!</span>
        `;
        feedbackElement.className = 'quiz-feedback success';
        feedbackElement.setAttribute('role', 'alert');
        feedbackElement.setAttribute('aria-live', 'polite');
        quizCard.classList.add('answered-correct');
      } else {
        feedbackElement.innerHTML = `
          <span class="feedback-icon" aria-hidden="true">‚úó</span> 
          <span class="feedback-text">Incorrect</span>
          <span class="correct-answer-display">
            <span class="correct-answer-label">Correct answer:</span> 
            <strong>${correctAnswer}</strong>
          </span>
        `;
        feedbackElement.className = 'quiz-feedback error';
        feedbackElement.setAttribute('role', 'alert');
        feedbackElement.setAttribute('aria-live', 'assertive');
        quizCard.classList.add('answered-incorrect');
      }
      feedbackElement.style.display = 'block';
      
      // Check if all quizzes answered (include subcategory)
      const totalQuizzes = getQuizData(currentLevel, currentCategory, currentSubcategory).length;
      console.log('DEBUG: totalQuizzes=', totalQuizzes, 'answered=', Object.keys(quizAnswers).length);
      if (document.getElementById('debug-answered')) {
        document.getElementById('debug-answered').textContent = Object.keys(quizAnswers).length;
      }
      const submitBtn = document.getElementById('submitQuizzes');
      if (submitBtn) {
        if (Object.keys(quizAnswers).length === totalQuizzes) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = 1;
          submitBtn.removeAttribute('aria-disabled');
          submitBtn.classList.remove('disabled');
          submitBtn.style.pointerEvents = 'auto';
          submitBtn.tabIndex = 0;
          // Extra: bring to front in case of overlay
          submitBtn.style.position = 'relative';
          submitBtn.style.zIndex = 9999;
          console.log('DEBUG: All questions answered, enabling submit button.');
          submitBtn.focus();
          // Extra debug: visually show if still disabled
          setTimeout(() => {
            if (submitBtn.disabled) {
              submitBtn.insertAdjacentHTML('afterend', '<div style="color:red;font-weight:bold;">DEBUG: Submit button is still disabled after force-enable!</div>');
            }
            submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        } else {
          submitBtn.disabled = true;
          submitBtn.setAttribute('aria-disabled', 'true');
          submitBtn.classList.add('disabled');
          submitBtn.style.opacity = 0.6;
        }
      } else {
        console.log('DEBUG: Submit button not found in DOM.');
      }
    }

    async function submitAllQuizzes() {
      console.log('DEBUG: submitAllQuizzes called');
      const totalQuizzes = Object.keys(quizAnswers).length;
      const correctCount = Object.values(quizAnswers).filter(answer => answer === true).length;
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üíæ SAVING QUIZ RESULTS TO DATABASE');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('Quiz Details:', {
        type: 'quiz',
        language: currentLanguage,
        level: currentLevel,
        score: `${correctCount}/${totalQuizzes}`,
        percentage: `${Math.round((correctCount/totalQuizzes)*100)}%`,
        timeSpent: `${timeSpent}s`
      });

      try {
        const result = await ProgressService.saveScore(
          'quiz',
          currentLanguage,
          currentLevel,
          correctCount,
          totalQuizzes,
          timeSpent
        );
        
        console.log('‚úÖ SUCCESS: Quiz results saved to database');
        console.log('Result:', result);
        
        // Show results on the page
        const percentage = Math.round((correctCount/totalQuizzes)*100);
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        
        // Determine encouraging message based on performance
        let message = '';
        let emoji = '';
        if (percentage === 100) {
          message = 'Perfect score!';
          emoji = 'üåü';
        } else if (percentage >= 90) {
          message = 'Excellent work!';
          emoji = 'üéâ';
        } else if (percentage >= 80) {
          message = 'Great progress!';
          emoji = 'üëè';
        } else if (percentage >= 70) {
          message = 'Good effort!';
          emoji = 'üëç';
        } else if (percentage >= 50) {
          message = 'Keep practicing!';
          emoji = 'üí™';
        } else {
          message = 'Keep going!';
          emoji = 'üìö';
        }
        
        document.getElementById('quizContainer').innerHTML = `
          <div class="quiz-results">
            <div class="results-header">
              <div class="results-emoji">${emoji}</div>
              <h2 class="results-title">${message}</h2>
            </div>
            
            <div class="results-stats">
              <div class="stat-card stat-primary">
                <div class="stat-value" style="color: ${percentage >= 70 ? 'var(--success)' : 'var(--error)'};">${percentage}%</div>
                <div class="stat-label">Score</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">${correctCount}/${totalQuizzes}</div>
                <div class="stat-label">Correct Answers</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">${minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`}</div>
                <div class="stat-label">Time Taken</div>
              </div>
            </div>
            
            <div class="results-actions">
              <button id="retryQuizBtn" class="btn btn-primary btn-large">Retry Quiz</button>
              <a href="quiz-select.html" class="btn btn-secondary btn-large">
                Back to Levels
              </a>
              <a href="progress.html" class="btn btn-outline btn-large">
                View Progress
              </a>
            </div>
          </div>
        `;
        
        // Set up Retry Quiz button handler
        setTimeout(() => {
          const retryBtn = document.getElementById('retryQuizBtn');
          if (retryBtn) {
            let url = 'quizzes.html?language=' + encodeURIComponent(currentLanguage) + '&level=' + encodeURIComponent(currentLevel);
            if (currentCategory) { url += '&category=' + encodeURIComponent(currentCategory); }
            if (currentSubcategory) { url += '&subcategory=' + encodeURIComponent(currentSubcategory); }
            retryBtn.onclick = function() { location.href = url; };
          }
        }, 0);
      } catch (error) {
        console.error('‚ùå FAILED: Could not save quiz results');
        console.error('Error:', error.message);
        
        // Show error results on the page
        const percentage = Math.round((correctCount/totalQuizzes)*100);
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        
        // Determine encouraging message based on performance
        let message = '';
        let emoji = '';
        if (percentage === 100) {
          message = 'Perfect score!';
          emoji = 'üåü';
        } else if (percentage >= 90) {
          message = 'Excellent work!';
          emoji = 'üéâ';
        } else if (percentage >= 80) {
          message = 'Great progress!';
          emoji = 'üëè';
        } else if (percentage >= 70) {
          message = 'Good effort!';
          emoji = 'üëç';
        } else if (percentage >= 50) {
          message = 'Keep practicing!';
          emoji = 'üí™';
        } else {
          message = 'Keep going!';
          emoji = 'üìö';
        }
        
        document.getElementById('quizContainer').innerHTML = `
          <div class="quiz-results">
            <div class="results-header">
              <div class="results-emoji">${emoji}</div>
              <h2 class="results-title">${message}</h2>
              <p class="results-note">Unable to save progress - please check your connection</p>
            </div>
            
            <div class="results-stats">
              <div class="stat-card stat-primary">
                <div class="stat-value" style="color: ${percentage >= 70 ? 'var(--success)' : 'var(--error)'};">${percentage}%</div>
                <div class="stat-label">Score</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">${correctCount}/${totalQuizzes}</div>
                <div class="stat-label">Correct Answers</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">${minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`}</div>
                <div class="stat-label">Time Taken</div>
              </div>
            </div>
            
            <div class="results-actions">
              <button id="retryQuizBtn" class="btn btn-primary btn-large">Retry Quiz</button>
              <a href="quiz-select.html" class="btn btn-secondary btn-large">
                Back to Levels
              </a>
              <a href="progress.html" class="btn btn-outline btn-large">
                View Progress
              </a>
            </div>
          </div>
        `;
        // Set up Retry Quiz button handler (error case)
        setTimeout(function() {
          const retryBtn = document.getElementById('retryQuizBtn');
          if (retryBtn) {
            let url = 'quizzes.html?language=' + encodeURIComponent(currentLanguage) + '&level=' + encodeURIComponent(currentLevel);
            if (currentCategory) { url += '&category=' + encodeURIComponent(currentCategory); }
            if (currentSubcategory) { url += '&subcategory=' + encodeURIComponent(currentSubcategory); }
            retryBtn.onclick = function() { location.href = url; };
          }
        }, 0);
      }
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      menu.classList.toggle('active');
      if (overlay) overlay.classList.toggle('active');
      
      // Prevent body scroll when menu is open
      if (menu.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      menu.classList.remove('active');
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  </script>
  <script src="app.js"></script>

</body>
</html>