<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Chinese Language Tests - Practice Mandarin">
  <title>Tests - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">LangTutor</div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
          â˜°
        </button>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html#home" class="nav-link" onclick="closeMobileMenu()">Home</a></li>
          <li><a href="quiz-select.html" class="nav-link">Quizzes</a></li>
          <li><a href="test-select.html" class="nav-link">Tests</a></li>
          <li><a href="flashcards.html" class="nav-link">Flashcards</a></li>
          <li><a href="progress.html" class="nav-link">Progress</a></li>
          <li><a href="resources.html" class="nav-link">Resources</a></li>
          <li><a href="writing.html" class="nav-link">Writing Practice</a></li>
        </ul>
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">ğŸŒ™</button>
      </div>
    </div>
  </nav>

  <section class="practice" id="practice">
    <div class="container">
      <h2>Chinese Language Test</h2>
      <p class="section-subtitle" id="subtitle">Loading...</p>
      <div id="authStatus" style="text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 8px; display: none;"></div>
      <div class="timer-display" id="timerDisplay" style="display: none;">â±ï¸ Time: <span id="timeElapsed">0:00</span></div>

      <div id="testContainer"></div>

      <div style="margin-top: 30px; text-align: center;">
        <button id="submitTest" class="btn btn-primary" style="display: none;" onclick="submitTest()">Submit Test</button>
        <div id="testResults" style="display: none; margin-top: 20px;">
          <h3>Test Results</h3>
          <p id="scoreDisplay" style="font-size: 1.5rem; margin: 20px 0;"></p>
          <p id="feedbackMessage" style="margin-bottom: 20px;"></p>
          <button id="shareBtn" class="share-btn" onclick="shareScore()" style="display: none;">ğŸ“¤ Share Score</button>
        </div>
      </div>

      <p style="margin-top: 30px;"><a href="test-select.html" class="btn btn-secondary">Back to Selection</a></p>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Chinese Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <!-- Load dependencies in correct order -->
  <script src="auth-service.js"></script>
  <script src="progress-service.js"></script>
  <script src="app.js"></script>
  <script src="quizzes.js"></script>
  <script>
    // Verify all required services are loaded
    if (typeof AuthService === 'undefined') {
      alert('ERROR: AuthService not loaded. Please refresh the page.');
      throw new Error('AuthService not loaded');
    }
    if (typeof ProgressService === 'undefined') {
      alert('ERROR: ProgressService not loaded. Please refresh the page.');
      throw new Error('ProgressService not loaded');
    }
    console.log('âœ“ All services loaded successfully');
  </script>
  <script>
    // Test data structure
    const testData = {
      newbie: {
        mandarin: [
          {
            id: 1,
            question: 'What is the pinyin for "ä½ å¥½"?',
            options: ['nihao', 'neihao', 'nÇhÇo', 'All of the above'],
            correctAnswer: 2
          },
          {
            id: 2,
            question: 'Which character means "one"?',
            options: ['äºŒ', 'ä¸€', 'ä¸‰', 'å››'],
            correctAnswer: 1
          },
          {
            id: 3,
            question: 'How do you say "thank you" in Mandarin?',
            options: ['xiexie', 'zaijian', 'duibuqi', 'qing'],
            correctAnswer: 0
          },
          {
            id: 4,
            question: 'What does "å†è§" mean?',
            options: ['Hello', 'Thank you', 'Goodbye', 'Sorry'],
            correctAnswer: 2
          },
          {
            id: 5,
            question: 'Which pinyin represents the character "æ°´" (water)?',
            options: ['shui', 'sui', 'shou', 'xui'],
            correctAnswer: 0
          }
        ]
      },
      level1: {
        mandarin: [
          {
            id: 1,
            question: 'What is the correct stroke order principle in Chinese?',
            options: ['Right to left, bottom to top', 'Left to right, top to bottom', 'Bottom to top, right to left', 'Random order'],
            correctAnswer: 1
          },
          {
            id: 2,
            question: 'Which character means "beautiful"?',
            options: ['å¥½', 'ç¾', 'å¤§', 'å°'],
            correctAnswer: 1
          },
          {
            id: 3,
            question: 'What does "æˆ‘çˆ±ä½ " mean?',
            options: ['I like you', 'I love you', 'I know you', 'I see you'],
            correctAnswer: 1
          },
          {
            id: 4,
            question: 'How do you say "restaurant" in Chinese?',
            options: ['é¥­åº—', 'å•†åº—', 'ä¹¦åº—', 'é…’åº—'],
            correctAnswer: 0
          },
          {
            id: 5,
            question: 'What is the measure word for books?',
            options: ['ä¸ª', 'æœ¬', 'å¼ ', 'æ¡'],
            correctAnswer: 1
          }
        ]
      },
      level2: {
        mandarin: [
          {
            id: 1,
            question: 'What does "å­¦æ ¡" mean?',
            options: ['Hospital', 'School', 'Library', 'Park'],
            correctAnswer: 1
          },
          {
            id: 2,
            question: 'Which is the correct word order in Mandarin?',
            options: ['Verb + Subject + Object', 'Subject + Verb + Object', 'Object + Subject + Verb', 'Subject + Object + Verb'],
            correctAnswer: 1
          },
          {
            id: 3,
            question: 'What does "æ˜¨å¤©" mean?',
            options: ['Today', 'Yesterday', 'Tomorrow', 'Now'],
            correctAnswer: 1
          },
          {
            id: 4,
            question: 'How do you say "I am a student" in Chinese?',
            options: ['æˆ‘æ˜¯è€å¸ˆ', 'æˆ‘æ˜¯å­¦ç”Ÿ', 'æˆ‘æ˜¯åŒ»ç”Ÿ', 'æˆ‘æ˜¯å¾‹å¸ˆ'],
            correctAnswer: 1
          },
          {
            id: 5,
            question: 'What is the meaning of "å›¾ä¹¦é¦†"?',
            options: ['Museum', 'Library', 'Gallery', 'Bookstore'],
            correctAnswer: 1
          }
        ]
      },
      level3: {
        mandarin: [
          {
            id: 1,
            question: 'Which classical Chinese text is attributed to Confucius?',
            options: ['è®ºè¯­ (Analects)', 'é“å¾·ç» (Tao Te Ching)', 'å­™å­å…µæ³• (Art of War)', 'æ˜“ç» (I Ching)'],
            correctAnswer: 0
          },
          {
            id: 2,
            question: 'What is a æˆè¯­ (chengyu)?',
            options: ['A type of poem', 'A four-character idiom', 'A dialect', 'A writing style'],
            correctAnswer: 1
          },
          {
            id: 3,
            question: 'Which radical is found in the character "æƒ³" (to think)?',
            options: ['å¿ƒ (heart)', 'æœ¨ (wood)', 'ç« (fire)', 'æ°´ (water)'],
            correctAnswer: 0
          },
          {
            id: 4,
            question: 'What does "ç”»è›‡æ·»è¶³" mean?',
            options: ['To paint a perfect picture', 'To add unnecessary details (ruin something)', 'To be very talented', 'To work hard'],
            correctAnswer: 1
          },
          {
            id: 5,
            question: 'In traditional Chinese culture, which number is considered unlucky?',
            options: ['3', '4', '7', '9'],
            correctAnswer: 1
          }
        ]
      },
      level4: {
        mandarin: []
      },
      level5: {
        mandarin: []
      },
      level6: {
        mandarin: []
      },
      sjkc: {
        mandarin: [
          {
            id: 1,
            question: 'What is the meaning of "åæ–‡"?',
            options: ['English language', 'Chinese language', 'Malay language', 'Tamil language'],
            correctAnswer: 1
          },
          {
            id: 2,
            question: 'What does the idiom "ä¸€çŸ³äºŒé¸Ÿ" mean?',
            options: ['Kill two birds with one stone', 'Birds of a feather', 'Early bird catches the worm', 'Free as a bird'],
            correctAnswer: 0
          },
          {
            id: 3,
            question: 'Which character means "country" or "nation"?',
            options: ['å›½', 'å®¶', 'äºº', 'åœ°'],
            correctAnswer: 0
          },
          {
            id: 4,
            question: 'What is the correct measure word for "ä¸€___è½¦" (one car)?',
            options: ['è¾†', 'ä¸ª', 'æœ¬', 'å¼ '],
            correctAnswer: 0
          },
          {
            id: 5,
            question: 'What does "å‹¤åŠ³" mean?',
            options: ['Lazy', 'Hardworking/Diligent', 'Smart', 'Wealthy'],
            correctAnswer: 1
          }
        ]
      }
    };

    let userAnswers = {};
    let currentLanguage = '';
    let currentLevel = '';
    let timerInterval = null;

    // Load test based on URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      // CRITICAL: Verify all required services are loaded
      if (typeof AuthService === 'undefined') {
        document.getElementById('testContainer').innerHTML = `
          <div class="card">
            <h3 style="color: #dc3545;">âŒ System Error</h3>
            <p>Authentication service failed to load. Please refresh the page.</p>
            <p>If the problem persists, clear your browser cache (Ctrl+Shift+R).</p>
          </div>
        `;
        return;
      }

      if (typeof ProgressService === 'undefined') {
        document.getElementById('testContainer').innerHTML = `
          <div class="card">
            <h3 style="color: #dc3545;">âŒ System Error</h3>
            <p>Progress service failed to load. Please refresh the page.</p>
            <p>If the problem persists, clear your browser cache (Ctrl+Shift+R).</p>
          </div>
        `;
        return;
      }

      console.log('âœ“ All services verified and ready');
      
      // Check and display authentication status
      const authStatusDiv = document.getElementById('authStatus');
      if (AuthService.isAuthenticated()) {
        const user = AuthService.getCurrentUser();
        authStatusDiv.innerHTML = 'âœ… Logged in as: <strong>' + (user?.name || user?.email || 'User') + '</strong> - Your progress will be saved!';
        authStatusDiv.style.background = '#d4edda';
        authStatusDiv.style.border = '2px solid #c3e6cb';
        authStatusDiv.style.color = '#155724';
        authStatusDiv.style.display = 'block';
      } else {
        // Not logged in - show prominent warning and require login
        authStatusDiv.innerHTML = `
          <h3 style="margin: 0 0 10px 0;">âš ï¸ Login Required</h3>
          <p style="margin: 0 0 10px 0;">You must be logged in to take tests and save your progress to the database.</p>
          <a href="login.html?redirect=tests.html${window.location.search}" style="color: white; background: #004085; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;">Login Now</a>
          <a href="signup.html?redirect=tests.html${window.location.search}" style="color: white; background: #28a745; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;">Sign Up</a>
        `;
        authStatusDiv.style.background = '#f8d7da';
        authStatusDiv.style.border = '2px solid #f5c6cb';
        authStatusDiv.style.color = '#721c24';
        authStatusDiv.style.display = 'block';
        
        // Hide the test content and submit button
        document.getElementById('testContainer').innerHTML = '<p style="text-align: center; padding: 40px;">Please login to take tests.</p>';
        const submitBtn = document.getElementById('submitTest');
        if (submitBtn) submitBtn.style.display = 'none';
        return;
      }

      const params = new URLSearchParams(window.location.search);
      currentLanguage = params.get('language');
      currentLevel = params.get('level');
      
      if (!currentLanguage || !currentLevel) {
        document.getElementById('subtitle').textContent = 'Invalid test selection';
        return;
      }

      const tests = testData[currentLevel]?.[currentLanguage];
      
      if (!tests) {
        document.getElementById('subtitle').textContent = 'Test not found';
        return;
      }

      loadTest(tests, currentLanguage, currentLevel);
    });

    function loadTest(tests, language, level) {
      const levelNames = {
        'newbie': 'Newbie',
        'level1': 'Level 1',
        'level2': 'Level 2',
        'level3': 'Level 3',
        'level4': 'Level 4',
        'level5': 'Level 5',
        'level6': 'Level 6',
        'sjkc': 'SJKC'
      };
      const levelName = levelNames[level] || level;
      document.getElementById('subtitle').textContent = `${language.charAt(0).toUpperCase() + language.slice(1)} - ${levelName} Level`;
      
      const container = document.getElementById('testContainer');
      
      if (!tests || tests.length === 0) {
        container.innerHTML = '<div class="card"><p style="text-align: center; font-size: 1.2rem;">ğŸ“š Tests for this level are coming soon! Stay tuned.</p></div>';
        document.getElementById('submitTest').style.display = 'none';
        return;
      }
      
      let html = '';

      tests.forEach((test, index) => {
        html += `
          <div class="card" style="margin-bottom: 30px;">
            <div class="question">Question ${index + 1}: ${test.question}</div>
            <div class="options">
              ${test.options.map((option, optIndex) => `
                <button class="option-btn" onclick="selectAnswer(${test.id}, ${optIndex})" data-test="${test.id}" data-option="${optIndex}">
                  ${option}
                </button>
              `).join('')}
            </div>
            <div id="result-${test.id}" class="feedback" style="display: none;"></div>
          </div>
        `;
      });

      container.innerHTML = html;
      document.getElementById('submitTest').style.display = 'inline-block';
      
      // Start timer
      if (typeof Timer !== 'undefined') {
        // Clear previous interval if exists
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        
        document.getElementById('timerDisplay').style.display = 'block';
        Timer.start();
        timerInterval = setInterval(() => {
          const elapsed = Timer.getElapsed();
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('timeElapsed').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
      }
    }

    function selectAnswer(testId, optionIndex) {
      // Clear previous selections for this question
      document.querySelectorAll(`[data-test="${testId}"]`).forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.borderColor = '';
      });

      // Highlight selected answer
      const selectedBtn = document.querySelector(`[data-test="${testId}"][data-option="${optionIndex}"]`);
      
      if (selectedBtn) {
        selectedBtn.style.background = 'var(--accent)';
        selectedBtn.style.color = 'white';
        selectedBtn.style.borderColor = 'var(--accent)';
      }

      // Store answer
      userAnswers[testId] = optionIndex;
    }

    async function submitTest() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸš€ SUBMIT TEST CALLED');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('Current Language:', currentLanguage);
      console.log('Current Level:', currentLevel);
      console.log('User Answers:', userAnswers);
      
      const tests = testData[currentLevel][currentLanguage];
      let correctCount = 0;
      let totalQuestions = tests.length;

      // Check if all questions are answered
      if (Object.keys(userAnswers).length < totalQuestions) {
        alert('Please answer all questions before submitting!');
        console.log('âŒ Not all questions answered');
        return;
      }
      
      console.log('âœ“ All questions answered:', totalQuestions);

      // Stop timer
      let timeSpent = 0;
      if (typeof Timer !== 'undefined') {
        timeSpent = Timer.stop() || 0;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // Grade the test
      tests.forEach(test => {
        const userAnswer = userAnswers[test.id];
        const isCorrect = userAnswer === test.correctAnswer;
        
        if (isCorrect) {
          correctCount++;
        }

        // Show feedback for each question
        const resultDiv = document.getElementById(`result-${test.id}`);
        if (resultDiv) {
          resultDiv.style.display = 'block';
          
          if (isCorrect) {
            resultDiv.className = 'feedback success';
            resultDiv.textContent = 'âœ“ Correct!';
          } else {
            resultDiv.className = 'feedback error';
            resultDiv.textContent = `âœ— Incorrect. Correct answer: ${test.options[test.correctAnswer]}`;
          }
        }
      });

      // Calculate percentage
      const percentage = Math.round((correctCount / totalQuestions) * 100);

      // CRITICAL: Save progress to database ONLY (NO localStorage fallback)
      try {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ’¾ SAVING PROGRESS TO DATABASE');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('Test Details:', {
          type: 'test',
          language: currentLanguage,
          level: currentLevel,
          score: `${correctCount}/${totalQuestions}`,
          percentage: `${percentage}%`,
          timeSpent: `${timeSpent}s`
        });
        
        // CRITICAL: ProgressService.saveScore will throw error if:
        // - Not authenticated
        // - API request fails
        // - Token is invalid/expired
        const result = await ProgressService.saveScore(
          'test',
          currentLanguage,
          currentLevel,
          correctCount,
          totalQuestions,
          timeSpent
        );
        
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âœ… SUCCESS: Progress saved to database');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('Result:', result);
        
      } catch (error) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('âŒ FAILED: Could not save progress');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('Error:', error.message);
        console.error('Full error:', error);
        
        // Show clear, actionable error to user
        const errorMessage = error.message || 'Unknown error';
        alert(
          `âš ï¸ FAILED TO SAVE YOUR PROGRESS\n\n` +
          `Your test score: ${percentage}%\n\n` +
          `Error: ${errorMessage}\n\n` +
          `âŒ Your progress was NOT saved to the database.\n\n` +
          `Please:\n` +
          `1. Check that you are logged in\n` +
          `2. Check your internet connection\n` +
          `3. Refresh the page and try again\n\n` +
          `If you see this repeatedly, contact support.`
        );
        
        // Still show the score even if save failed
      }

      // Show overall results
      const resultsDiv = document.getElementById('testResults');
      const scoreDisplay = document.getElementById('scoreDisplay');
      const feedbackMessage = document.getElementById('feedbackMessage');

      console.log('Displaying results:', { correctCount, totalQuestions, percentage });

      if (scoreDisplay) {
        scoreDisplay.textContent = `Score: ${correctCount}/${totalQuestions} (${percentage}%)`;
      }
      
      if (feedbackMessage) {
        if (percentage >= 90) {
          feedbackMessage.textContent = 'ğŸ‰ Excellent! You have mastered this level!';
          feedbackMessage.style.color = 'var(--success)';
        } else if (percentage >= 70) {
          feedbackMessage.textContent = 'ğŸ‘ Good job! Keep practicing to improve.';
          feedbackMessage.style.color = 'var(--accent)';
        } else if (percentage >= 50) {
          feedbackMessage.textContent = 'ğŸ“š Not bad, but you need more practice.';
          feedbackMessage.style.color = 'var(--warning)';
        } else {
          feedbackMessage.textContent = 'ğŸ’ª Keep studying! You\'ll improve with practice.';
          feedbackMessage.style.color = 'var(--error)';
        }
      }

      if (resultsDiv) {
        resultsDiv.style.display = 'block';
      }
      
      const submitBtn = document.getElementById('submitTest');
      if (submitBtn) {
        submitBtn.style.display = 'none';
      }
      
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) {
        shareBtn.style.display = 'inline-block';
      }

      // Disable all option buttons
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.cursor = 'not-allowed';
      });

      // Scroll to results
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function shareScore() {
      const tests = testData[currentLevel][currentLanguage];
      const correctAnswers = Object.keys(userAnswers).filter(id => 
        userAnswers[id] === tests.find(t => t.id == id).correctAnswer
      ).length;
      const totalQuestions = tests.length;
      const percentage = Math.round((correctAnswers / totalQuestions) * 100);
      
      if (typeof SocialShare !== 'undefined') {
        SocialShare.shareScore(`Chinese ${currentLanguage.charAt(0).toUpperCase() + currentLanguage.slice(1)} Test`, currentLevel, correctAnswers, totalQuestions, 'test');
      }
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.toggle('active');
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.classList.remove('active');
    }
  </script>

</body>
</html>
