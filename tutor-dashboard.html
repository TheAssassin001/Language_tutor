<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutor Dashboard - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .dashboard-container { min-height: 100vh; padding: 80px 0 40px; }
    .dashboard-header { background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; padding: 30px 0; margin-bottom: 40px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: var(--bg-secondary); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid var(--border); }
    .stat-card h3 { font-size: .9rem; color: var(--text-secondary); margin-bottom: 10px; }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--accent); }
    .students-table { background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 2px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th { background: var(--accent); color: white; padding: 15px; text-align: left; }
    td { padding: 15px; border-bottom: 1px solid var(--border); }
    tr:hover { background: var(--bg-primary); cursor: pointer; }
    .btn-view { background: var(--primary); color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 1000; overflow-y: auto; }
    .modal.show { display: block; }
    .modal-content { background: var(--bg-primary); max-width: 900px; margin: 50px auto; border-radius: 12px; padding: 30px; position: relative; }
    .modal-close { position: absolute; top: 20px; right: 20px; font-size: 2rem; background: none; border: none; cursor: pointer; }
    .loading,.empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
  </style>
</head>

<body>

<nav class="navbar">
  <div class="container">
    <div class="nav-wrapper">
      <div class="logo">‰∏≠ÊñáÁªÉ‰π†</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="tutor-dashboard.html">Dashboard</a></li>
        <li><span id="userNameNav" style="color:var(--accent)">Loading...</span></li>
        <li><a href="#" onclick="AuthService.logout();return false;">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="dashboard-header">
  <div class="container">
    <h1>üìä Tutor Dashboard</h1>
    <p id="welcomeMessage">Welcome back</p>
  </div>
</div>

<section class="dashboard-container">
  <div class="container">

    <h2>Overall Analytics</h2>
    <div id="analyticsStats" class="stats-grid">
      <div class="loading">Loading analytics...</div>
    </div>


    <body>

      <nav class="navbar">
        <div class="container">
          <div class="nav-wrapper">
            <div class="logo">‰∏≠ÊñáÁªÉ‰π†</div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
              ‚ò∞
            </button>
            <ul class="nav-links" id="mobileMenu">
              <li><a href="index.html" class="nav-link">Home</a></li>
              <li><a href="tutor-dashboard.html" class="nav-link">Dashboard</a></li>
              <li><span id="userNameNav" class="nav-link" style="color: var(--accent);">Loading...</span></li>
              <li><a href="#" onclick="AuthService.logout(); return false;" class="nav-link">Logout</a></li>
            </ul>
            <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
          </div>
        </div>
      </nav>

      <div class="dashboard-header">
        <div class="container">
          <h1>üìä Tutor Dashboard</h1>
          <p id="welcomeMessage">Welcome back, Tutor</p>
        </div>
      </div>

      <section class="dashboard-container">
        <div class="container">
      
          <!-- Pending Approvals -->
          <div id="pendingApprovalsSection"></div>

          <!-- Overall Analytics -->
          <h2>Overall Analytics</h2>
          <div class="stats-grid" id="analyticsStats">
            <div class="loading">Loading analytics...</div>
          </div>

          <!-- Students List -->
          <h2 style="margin-top: 40px;">Your Students</h2>
          <div class="students-table" id="studentsTable">
            <div class="loading">Loading students...</div>
          </div>

        </div>
      </section>

      <!-- Student Detail Modal -->
      <div id="studentModal" class="modal">
        <div class="modal-content">
          <button class="modal-close" onclick="closeModal()">&times;</button>
          <div id="modalContent">
            <div class="loading">Loading student details...</div>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="container">
          <p>&copy; 2026 Chinese Language Tutor. All rights reserved.</p>
        </div>
      </footer>

      <script src="auth-service.js"></script>
      <script src="app.js"></script>
      <script>
        // Require tutor access
        AuthService.requireRole('tutor');

        // Load dashboard data
        async function loadDashboard() {
          const user = AuthService.getCurrentUser();
          if (user) {
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.name}`;
            document.getElementById('userNameNav').textContent = user.name;
          }

          await Promise.all([
            loadPendingApprovals(),
            loadAnalytics(),
            loadStudents()
          ]);
        }

        async function loadPendingApprovals() {
          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
        
            const response = await fetch(`${API_URL}/tutor/pending-students`, {
              headers: AuthService.getAuthHeaders()
            });
        
            const data = await response.json();
            console.log('Pending students:', data);

            if (data.success && data.data && data.data.length > 0) {
              const html = `
                <div class="pending-approvals">
                  <h2>
                    ‚è≥ Pending Approvals 
                    <span class="pending-badge">${data.data.length}</span>
                  </h2>
                  <p style="margin: 10px 0; color: #856404;">New students waiting for your approval to access the platform</p>
                  <div class="pending-list">
                    ${data.data.map(student => `
                      <div class="pending-card">
                        <div class="pending-info">
                          <h4>${student.name}</h4>
                          <p>${student.email}</p>
                          <p style="font-size: 0.85rem; margin-top: 5px;">
                            Registered: ${new Date(student.createdAt).toLocaleDateString()} at ${new Date(student.createdAt).toLocaleTimeString()}
                          </p>
                        </div>
                        <div class="pending-actions">
                          <button class="btn-approve" onclick="approveStudent('${student._id}', '${student.name}')">
                            ‚úì Approve
                          </button>
                          <button class="btn-reject" onclick="rejectStudent('${student._id}', '${student.name}')">
                            ‚úó Reject
                          </button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
              document.getElementById('pendingApprovalsSection').innerHTML = html;
            } else {
              // No pending approvals - show nothing or a minimal message
              document.getElementById('pendingApprovalsSection').innerHTML = '';
            }
          } catch (error) {
            console.error('Error loading pending approvals:', error);
            document.getElementById('pendingApprovalsSection').innerHTML = '';
          }
        }

        async function approveStudent(studentId, studentName) {
          if (!confirm(`Approve ${studentName}?\n\nThis will allow them to access the platform and start learning.`)) {
            return;
          }

          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
        
            const response = await fetch(`${API_URL}/tutor/approve-student/${studentId}`, {
              method: 'PUT',
              headers: AuthService.getAuthHeaders()
            });

            const data = await response.json();

            if (data.success) {
              alert(`‚úÖ ${studentName} has been approved!\n\nThey can now log in and access the platform.`);
              loadDashboard(); // Refresh the dashboard
            } else {
              alert(`‚ùå Failed to approve student: ${data.message}`);
            }
          } catch (error) {
            console.error('Error approving student:', error);
            alert(`‚ùå Error: ${error.message}`);
          }
        }

        async function rejectStudent(studentId, studentName) {
          if (!confirm(`Reject ${studentName}?\n\nThey will not be able to access the platform and will see an error message when trying to log in.`)) {
            return;
          }

          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
        
            const response = await fetch(`${API_URL}/tutor/reject-student/${studentId}`, {
              method: 'PUT',
              headers: AuthService.getAuthHeaders()
            });

            const data = await response.json();

            if (data.success) {
              alert(`‚ùå ${studentName} has been rejected.\n\nThey will see an error message when trying to log in.`);
              loadDashboard(); // Refresh the dashboard
            } else {
              alert(`‚ùå Failed to reject student: ${data.message}`);
            }
          } catch (error) {
            console.error('Error rejecting student:', error);
            alert(`‚ùå Error: ${error.message}`);
          }
        }

        async function loadAnalytics() {
          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
            console.log('Fetching analytics from:', `${API_URL}/tutor/analytics`);
        
            const response = await fetch(`${API_URL}/tutor/analytics`, {
              headers: AuthService.getAuthHeaders()
            });
        
            console.log('Analytics response status:', response.status);
            const data = await response.json();
            console.log('Analytics data:', data);

            if (data.success) {
              const stats = data.data;
              const html = `
                <div class="stat-card">
                  <h3>Total Students</h3>
                  <p class="stat-value">${stats.totalStudents || 0}</p>
                </div>
                <div class="stat-card">
                  <h3>Active Students</h3>
                  <p class="stat-value">${stats.activeStudents || 0}</p>
                </div>
                <div class="stat-card">
                  <h3>Total Activities</h3>
                  <p class="stat-value">${stats.totalActivities || 0}</p>
                </div>
                <div class="stat-card">
                  <h3>Avg Score</h3>
                  <p class="stat-value">${stats.averageScore || 0}%</p>
                </div>
              `;
              document.getElementById('analyticsStats').innerHTML = html;
            } else {
              console.error('Analytics failed:', data.message);
              document.getElementById('analyticsStats').innerHTML = `<p class="empty-state">Error: ${data.message || 'Failed to load analytics'}</p>`;
            }
          } catch (error) {
            console.error('Error loading analytics:', error);
            document.getElementById('analyticsStats').innerHTML = `<p class="empty-state">Error loading analytics: ${error.message}</p>`;
          }
        }

        async function loadStudents() {
          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
            console.log('Fetching students from:', `${API_URL}/tutor/students`);
        
            const response = await fetch(`${API_URL}/tutor/students`, {
              headers: AuthService.getAuthHeaders()
            });
        
            console.log('Students response status:', response.status);
            const data = await response.json();
            console.log('Students data:', data);

            if (data.success) {
              if (data.data && data.data.length > 0) {
                const html = `
                  <table>
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Total Activities</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.data.map(student => `
                        <tr onclick="viewStudent('${student.id}')">
                          <td><strong>${student.name}</strong></td>
                          <td>${student.email}</td>
                          <td>${student.totalActivities || 0}</td>
                          <td>${student.lastActivity ? new Date(student.lastActivity).toLocaleDateString() : 'Never'}</td>
                          <td>
                            <button class="btn-view" onclick="event.stopPropagation(); viewStudent('${student.id}')">View Details</button>
                            <button class="btn-view" style="background:#e74c3c;margin-left:8px;" onclick="event.stopPropagation(); window.deleteStudentFromList('${student.id}','${student.name}')">Delete</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                `;
                document.getElementById('studentsTable').innerHTML = html;
              // Delete student from dashboard list (global)
              window.deleteStudentFromList = async function(studentId, studentName) {
                if (!confirm(`Delete student ${studentName}? This cannot be undone.`)) return;
                try {
                  const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
                  const response = await fetch(`${API_URL}/tutor/students/${studentId}`, {
                    method: 'DELETE',
                    headers: AuthService.getAuthHeaders()
                  });
                  const data = await response.json();
                  if (data.success) {
                    alert('Student deleted.');
                    loadStudents();
                  } else {
                    alert('Failed to delete: ' + (data.message || 'Unknown error'));
                  }
                } catch (e) {
                  alert('Error: ' + e.message);
                }
              }
              } else {
                document.getElementById('studentsTable').innerHTML = `
                  <div class="empty-state">
                    <h3>üìö No students yet</h3>
                    <p>Students who sign up will appear here</p>
                  </div>
                `;
              }
            } else {
              console.error('Students fetch failed:', data.message);
              document.getElementById('studentsTable').innerHTML = `
                <div class="empty-state">
                  <h3>Error loading students</h3>
                  <p>${data.message || 'Unknown error'}</p>
                </div>
              `;
            }
          } catch (error) {
            console.error('Error loading students:', error);
            document.getElementById('studentsTable').innerHTML = `<p class="empty-state">Error: ${error.message}</p>`;
          }
        }

        async function viewStudent(studentId) {
          document.getElementById('studentModal').classList.add('show');
          document.getElementById('modalContent').innerHTML = '<div class="loading">Loading student details...</div>';

          try {
            const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://language-tutor-efn5.onrender.com/api';
            console.log('Fetching student details for:', studentId);
        
            const response = await fetch(`${API_URL}/tutor/students/${studentId}`, {
              headers: AuthService.getAuthHeaders()
            });
        
            console.log('Student details response status:', response.status);
            const data = await response.json();
            console.log('Student details data:', data);

            if (data.success) {
              const student = data.data.student;
              const stats = data.data.statistics;
              const streak = data.data.streak;
              const recent = data.data.recentActivity;

              const html = `
                <h2>${student.name}</h2>
                <p style="color: var(--text-secondary);">${student.email}</p>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                  Joined: ${new Date(student.createdAt).toLocaleDateString()} | 
                  Last Active: ${new Date(student.lastActive).toLocaleDateString()}
                </p>

                <div class="progress-grid">
                  <div class="progress-item">
                    <h4>üî• Current Streak</h4>
                    <div class="value">${streak.current}</div>
                  </div>
                  <div class="progress-item">
                    <h4>üèÜ Best Streak</h4>
                    <div class="value">${streak.best}</div>
                  </div>
                  <div class="progress-item">
                    <h4>üìù Total Tests</h4>
                    <div class="value">${stats.totalTests}</div>
                  </div>
                  <div class="progress-item">
                    <h4>üéØ Total Quizzes</h4>
                    <div class="value">${stats.totalQuizzes}</div>
                  </div>
                  <div class="progress-item">
                    <h4>‚≠ê Average Score</h4>
                    <div class="value">${stats.averageScore}%</div>
                  </div>
                  <div class="progress-item">
                    <h4>üéñÔ∏è Best Score</h4>
                    <div class="value">${stats.bestScore}%</div>
                  </div>
                </div>

                <h3 style="margin-top: 30px;">Progress by Level</h3>
                <div class="progress-grid">
                  ${Object.entries(stats.byLevel).map(([key, level]) => `
                    <div class="progress-item">
                      <h4>${level.level.toUpperCase()}</h4>
                      <div class="value">${level.averageScore}%</div>
                      <p style="font-size: 0.8rem; margin: 5px 0 0 0; color: var(--text-secondary);">
                        ${level.tests + level.quizzes} activities
                      </p>
                    </div>
                  `).join('')}
                </div>

                <h3 style="margin-top: 30px;">Recent Activity</h3>
                <div class="activity-list">
                  ${recent.length > 0 ? recent.map(activity => `
                    <div class="activity-item">
                      <div>
                        <strong>${activity.type === 'test' ? 'üìù Test' : 'üéØ Quiz'}</strong> - 
                        ${activity.level.toUpperCase()} - 
                        <span style="color: ${activity.percentage >= 80 ? '#27ae60' : activity.percentage >= 60 ? '#f39c12' : '#e74c3c'}">
                          ${activity.percentage}%
                        </span>
                      </div>
                      <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        ${new Date(activity.completedAt).toLocaleDateString()}
                      </div>
                    </div>
                  `).join('') : '<p class="empty-state">No recent activity</p>'}
                </div>
              `;

              document.getElementById('modalContent').innerHTML = html;
            } else {
              console.error('Failed to load student details:', data.message);
              document.getElementById('modalContent').innerHTML = `<p class="empty-state">Error: ${data.message || 'Failed to load student details'}</p>`;
            }
          } catch (error) {
            console.error('Error loading student details:', error);
            document.getElementById('modalContent').innerHTML = `<p class="empty-state">Error: ${error.message}</p>`;
          }
        }

        function closeModal() {
          document.getElementById('studentModal').classList.remove('show');
        }



        // Close modal on outside click
        document.getElementById('studentModal').addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal();
          }
        });

        // Load dashboard on page load
        loadDashboard();
      </script>
