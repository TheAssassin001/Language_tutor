<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutor Dashboard - Chinese Language Tutor</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-container {
      min-height: 100vh;
      padding: 80px 0 40px;
    }
    .dashboard-header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 40px;
    }
    .dashboard-header h1 {
      margin: 0 0 10px 0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .stat-card {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--border);
    }
    .stat-card h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 10px 0;
      text-transform: uppercase;
    }
    .stat-card .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
      margin: 0;
    }
    .students-table {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
    }
    .students-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .students-table th {
      background: var(--accent);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    .students-table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }
    .students-table tr:hover {
      background: var(--bg-primary);
      cursor: pointer;
    }
    .btn-view {
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-view:hover {
      background: var(--accent);
    }
    .student-detail {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid var(--border);
    }
    .student-detail h3 {
      margin-top: 0;
      color: var(--accent);
    }
    .progress-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .progress-item {
      background: var(--bg-primary);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .progress-item h4 {
      margin: 0 0 5px 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .progress-item .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal.show {
      display: block;
    }
    .modal-content {
      background: var(--bg-primary);
      max-width: 900px;
      margin: 50px auto;
      border-radius: 12px;
      padding: 30px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .modal-close:hover {
      color: var(--accent);
    }
    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .activity-item {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state h3 {
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <div class="nav-wrapper">
        <div class="logo">‰∏≠ÊñáÁªÉ‰π†</div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
          ‚ò∞
        </button>
        <ul class="nav-links" id="mobileMenu">
          <li><a href="index.html" class="nav-link">Home</a></li>
          <li><a href="tutor-dashboard.html" class="nav-link">Dashboard</a></li>
          <li><span id="userNameNav" class="nav-link" style="color: var(--accent);">Loading...</span></li>
          <li><a href="#" onclick="AuthAPI.logout(); return false;" class="nav-link">Logout</a></li>
        </ul>
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="DarkMode.toggle()" aria-label="Toggle dark mode">üåô</button>
      </div>
    </div>
  </nav>

  <div class="dashboard-header">
    <div class="container">
      <h1>üìä Tutor Dashboard</h1>
      <p id="welcomeMessage">Welcome back, Tutor</p>
    </div>
  </div>

  <section class="dashboard-container">
    <div class="container">
      
      <!-- Overall Analytics -->
      <h2>Overall Analytics</h2>
      <div class="stats-grid" id="analyticsStats">
        <div class="loading">Loading analytics...</div>
      </div>

      <!-- Students List -->
      <h2 style="margin-top: 40px;">Your Students</h2>
      <div class="students-table" id="studentsTable">
        <div class="loading">Loading students...</div>
      </div>

    </div>
  </section>

  <!-- Student Detail Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div id="modalContent">
        <div class="loading">Loading student details...</div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 Chinese Language Tutor. All rights reserved.</p>
    </div>
  </footer>

  <script src="app.js"></script>
  <script src="auth-client.js"></script>
  <script>
    // Require tutor access
    AuthAPI.requireTutor();

    // Load dashboard data
    async function loadDashboard() {
      const user = AuthAPI.getCurrentUser();
      if (user) {
        document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.name}`;
        document.getElementById('userNameNav').textContent = user.name;
      }

      await Promise.all([
        loadAnalytics(),
        loadStudents()
      ]);
    }

    async function loadAnalytics() {
      try {
        const response = await fetch('http://localhost:5000/api/tutor/analytics', {
          headers: AuthAPI.getAuthHeaders()
        });
        const data = await response.json();

        if (data.success) {
          const stats = data.data;
          const html = `
            <div class="stat-card">
              <h3>Total Students</h3>
              <p class="stat-value">${stats.totalStudents}</p>
            </div>
            <div class="stat-card">
              <h3>Active Students</h3>
              <p class="stat-value">${stats.activeStudents}</p>
            </div>
            <div class="stat-card">
              <h3>Total Activities</h3>
              <p class="stat-value">${stats.totalActivities}</p>
            </div>
            <div class="stat-card">
              <h3>Avg Score</h3>
              <p class="stat-value">${stats.averageScore}%</p>
            </div>
          `;
          document.getElementById('analyticsStats').innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsStats').innerHTML = '<p class="empty-state">Error loading analytics</p>';
      }
    }

    async function loadStudents() {
      try {
        const response = await fetch('http://localhost:5000/api/tutor/students', {
          headers: AuthAPI.getAuthHeaders()
        });
        const data = await response.json();

        if (data.success && data.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Total Activities</th>
                  <th>Last Activity</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${data.data.map(student => `
                  <tr onclick="viewStudent('${student.id}')">
                    <td><strong>${student.name}</strong></td>
                    <td>${student.email}</td>
                    <td>${student.totalActivities}</td>
                    <td>${student.lastActivity ? new Date(student.lastActivity).toLocaleDateString() : 'Never'}</td>
                    <td><button class="btn-view" onclick="event.stopPropagation(); viewStudent('${student.id}')">View Details</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          document.getElementById('studentsTable').innerHTML = html;
        } else {
          document.getElementById('studentsTable').innerHTML = `
            <div class="empty-state">
              <h3>üìö No students yet</h3>
              <p>Students who sign up will appear here</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('studentsTable').innerHTML = '<p class="empty-state">Error loading students</p>';
      }
    }

    async function viewStudent(studentId) {
      document.getElementById('studentModal').classList.add('show');
      document.getElementById('modalContent').innerHTML = '<div class="loading">Loading student details...</div>';

      try {
        const response = await fetch(`http://localhost:5000/api/tutor/students/${studentId}`, {
          headers: AuthAPI.getAuthHeaders()
        });
        const data = await response.json();

        if (data.success) {
          const student = data.data.student;
          const stats = data.data.statistics;
          const streak = data.data.streak;
          const recent = data.data.recentActivity;

          const html = `
            <h2>${student.name}</h2>
            <p style="color: var(--text-secondary);">${student.email}</p>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
              Joined: ${new Date(student.createdAt).toLocaleDateString()} | 
              Last Active: ${new Date(student.lastActive).toLocaleDateString()}
            </p>

            <div class="progress-grid">
              <div class="progress-item">
                <h4>üî• Current Streak</h4>
                <div class="value">${streak.current}</div>
              </div>
              <div class="progress-item">
                <h4>üèÜ Best Streak</h4>
                <div class="value">${streak.best}</div>
              </div>
              <div class="progress-item">
                <h4>üìù Total Tests</h4>
                <div class="value">${stats.totalTests}</div>
              </div>
              <div class="progress-item">
                <h4>üéØ Total Quizzes</h4>
                <div class="value">${stats.totalQuizzes}</div>
              </div>
              <div class="progress-item">
                <h4>‚≠ê Average Score</h4>
                <div class="value">${stats.averageScore}%</div>
              </div>
              <div class="progress-item">
                <h4>üéñÔ∏è Best Score</h4>
                <div class="value">${stats.bestScore}%</div>
              </div>
            </div>

            <h3 style="margin-top: 30px;">Progress by Level</h3>
            <div class="progress-grid">
              ${Object.entries(stats.byLevel).map(([key, level]) => `
                <div class="progress-item">
                  <h4>${level.level.toUpperCase()}</h4>
                  <div class="value">${level.averageScore}%</div>
                  <p style="font-size: 0.8rem; margin: 5px 0 0 0; color: var(--text-secondary);">
                    ${level.tests + level.quizzes} activities
                  </p>
                </div>
              `).join('')}
            </div>

            <h3 style="margin-top: 30px;">Recent Activity</h3>
            <div class="activity-list">
              ${recent.length > 0 ? recent.map(activity => `
                <div class="activity-item">
                  <div>
                    <strong>${activity.type === 'test' ? 'üìù Test' : 'üéØ Quiz'}</strong> - 
                    ${activity.level.toUpperCase()} - 
                    <span style="color: ${activity.percentage >= 80 ? '#27ae60' : activity.percentage >= 60 ? '#f39c12' : '#e74c3c'}">
                      ${activity.percentage}%
                    </span>
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    ${new Date(activity.completedAt).toLocaleDateString()}
                  </div>
                </div>
              `).join('') : '<p class="empty-state">No recent activity</p>'}
            </div>
          `;

          document.getElementById('modalContent').innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading student details:', error);
        document.getElementById('modalContent').innerHTML = '<p class="empty-state">Error loading student details</p>';
      }
    }

    function closeModal() {
      document.getElementById('studentModal').classList.remove('show');
    }

    // Close modal on outside click
    document.getElementById('studentModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Load dashboard on page load
    loadDashboard();
  </script>
</body>
</html>
